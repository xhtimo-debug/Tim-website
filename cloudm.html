<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº‘æœµå­—ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Zcool+KuaiLe&family=Pacifico&family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@400;700&family=Nunito:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Fredoka One', 'Zcool KuaiLe', sans-serif;
            background-color: #f3f4f6;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
            height: 100vh;
            width: 100vw;
            position: fixed; /* é”æ­»é¡µé¢é˜²æ­¢å›å¼¹ */
        }

        /* --- å¸ƒå±€æ¡†æ¶ (ç»å¯¹å®šä½æµ) --- */
        
        #app-header {
            position: absolute; top: 0; left: 0; right: 0;
            height: 56px;
            background: white;
            z-index: 5000;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        #app-canvas-area {
            position: absolute;
            top: 56px; 
            bottom: 60px; /* ç•™ç»™åº•éƒ¨å¯¼èˆª */
            left: 0; right: 0;
            background: #f1f5f9;
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            z-index: 1;
        }

        #app-bottom-nav {
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 60px;
            background: white;
            z-index: 5000;
            border-top: 1px solid #e2e8f0;
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- ç”»å¸ƒå®ä½“ --- */
        #canvas-container {
            background-color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden; /* è£å‰ªæº¢å‡º */
        }

        /* --- æŠ½å±‰ (Bottom Sheet) --- */
        .drawer {
            position: absolute;
            left: 0; right: 0;
            bottom: 60px; /* ååœ¨å¯¼èˆªæ ä¸Šé¢ */
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 30px rgba(0,0,0,0.1);
            z-index: 4000; /* åœ¨å¯¼èˆªæ ä¸‹é¢ï¼Œä½†åœ¨ç”»å¸ƒä¸Šé¢ */
            transform: translateY(120%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            max-height: 50%; /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œé˜²æ­¢é®æŒ¡ç”»å¸ƒ */
            display: flex; flex-direction: column;
            border-top: 1px solid #f1f5f9;
        }
        .drawer.open { transform: translateY(0); }

        .drawer-header {
            padding: 12px 16px; border-bottom: 1px solid #f1f5f9;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        .drawer-content {
            padding: 16px; overflow-y: auto; flex: 1;
        }

        /* --- ç»„ä»¶æ ·å¼ --- */
        .top-btn {
            background: #eff6ff; color: #3b82f6; 
            padding: 8px 12px; border-radius: 99px; 
            font-size: 12px; font-weight: bold;
            display: flex; align-items: center; gap: 4px;
        }
        .top-btn:active { transform: scale(0.95); }
        .top-btn.save { background: #3b82f6; color: white; }

        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; color: #94a3b8; font-size: 10px; font-weight: bold; gap: 2px;
        }
        .nav-item i { font-size: 20px; }
        .nav-item.active { color: #3b82f6; background: #eff6ff; }
        .nav-item.disabled { opacity: 0.3; pointer-events: none; filter: grayscale(1); }

        /* å…ƒç´ æ§åˆ¶æ‰‹æŸ„ */
        .draggable-item { position: absolute; padding: 0; border: 1px dashed transparent; transform-origin: center; }
        .draggable-item.active { border-color: #3b82f6; z-index: 9999 !important; }
        
        .handle-btn {
            position: absolute; width: 30px; height: 30px;
            background: white; border: 2px solid #3b82f6; border-radius: 50%;
            display: none; z-index: 10000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            color: #3b82f6; align-items: center; justify-content: center; font-size: 14px;
        }
        .resize-handle { bottom: -15px; right: -15px; }
        .rotate-handle { top: -40px; left: 50%; transform: translateX(-50%); color: #10b981; border-color: #10b981; }
        .rotate-handle::after { content: ''; position: absolute; top: 28px; width: 2px; height: 12px; background: #10b981; }
        .delete-handle { top: -15px; left: -15px; color: #ef4444; border-color: #ef4444; }
        .draggable-item.active .handle-btn { display: flex; }

        /* é¢œè‰²é€‰æ‹©å™¨ */
        .color-well {
            width: 100%; height: 36px; border-radius: 8px; border: 2px solid #e2e8f0;
            position: relative; overflow: hidden;
        }
        .color-well input { position: absolute; top:-50%; left:-50%; width:200%; height:200%; opacity:0; cursor:pointer; }
        
        input[type="range"] {
            width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; outline: none; -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px;
            background: white; border: 2px solid #3b82f6; border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <!-- é¡¶éƒ¨ -->
    <header id="app-header">
        <div class="flex gap-2">
            <button onclick="addCloudText()" class="top-btn">
                <i class="fa-solid fa-plus"></i> æ–‡å­—
            </button>
            <button onclick="openDrawer('drawer-stickers')" class="top-btn" style="background:#fff7ed; color:#f59e0b;">
                <i class="fa-regular fa-face-smile"></i> è´´çº¸
            </button>
        </div>
        <button onclick="exportImage()" class="top-btn save">
            <i class="fa-solid fa-download"></i> ä¿å­˜
        </button>
    </header>

    <!-- ä¸­é—´ç”»å¸ƒåŒºåŸŸ -->
    <div id="app-canvas-area">
        <div id="canvas-container">
            <!-- çº¯ç™½èƒŒæ™¯ -->
            <div class="absolute inset-0 bg-white"></div>
            <!-- ç½‘æ ¼ -->
            <div id="grid-layer" class="absolute inset-0 pointer-events-none opacity-10" 
                 style="background-image: linear-gradient(#94a3b8 1px, transparent 1px), linear-gradient(90deg, #94a3b8 1px, transparent 1px); background-size: 20px 20px;">
            </div>
            <!-- å…ƒç´ å±‚ -->
            <div id="item-layer" class="absolute inset-0 w-full h-full overflow-hidden"></div>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <nav id="app-bottom-nav">
        <button onclick="switchTab('style')" class="nav-item" id="nav-style">
            <i class="fa-solid fa-paintbrush"></i> æ ·å¼
        </button>
        <button onclick="switchTab('adjust')" class="nav-item" id="nav-adjust">
            <i class="fa-solid fa-sliders"></i> è°ƒæ•´
        </button>
        <button onclick="switchTab('tools')" class="nav-item" id="nav-tools">
            <i class="fa-solid fa-layer-group"></i> å·¥å…·
        </button>
    </nav>

    <!-- å±æ€§æŠ½å±‰ -->
    <div id="main-drawer" class="drawer">
        <div class="drawer-header">
            <h3 class="font-bold text-gray-800" id="drawer-title">å±æ€§</h3>
            <button onclick="closeDrawer()" class="text-gray-400 p-2"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="drawer-content">
            
            <!-- æ ·å¼ -->
            <div id="tab-style" class="tab-content">
                <div id="text-input-group" class="mb-4">
                    <label class="text-xs text-gray-400 font-bold block mb-1">å†…å®¹</label>
                    <input type="text" id="inp-text" class="w-full bg-gray-50 border rounded-lg px-3 py-2 text-sm">
                </div>
                
                <div id="color-group" class="grid grid-cols-3 gap-3 mb-4">
                    <div>
                        <label class="text-[10px] text-gray-400 block text-center mb-1">å­—è‰²</label>
                        <div class="color-well" style="background:#3b82f6" id="well-fill">
                            <input type="color" id="inp-fill">
                        </div>
                    </div>
                    <div id="box-stroke">
                        <label class="text-[10px] text-gray-400 block text-center mb-1">äº‘æœµ</label>
                        <div class="color-well" style="background:#ffffff" id="well-stroke">
                            <input type="color" id="inp-stroke">
                        </div>
                    </div>
                    <div id="box-outer">
                        <label class="text-[10px] text-gray-400 block text-center mb-1">è½®å»“</label>
                        <div class="color-well" style="background:#93c5fd" id="well-outer">
                            <input type="color" id="inp-outer">
                        </div>
                    </div>
                </div>

                <div id="font-group">
                    <label class="text-xs text-gray-400 font-bold block mb-1">å­—ä½“</label>
                    <select id="inp-font" class="w-full bg-white border rounded-lg px-2 py-2 text-sm">
                        <option value="'Fredoka One', cursive">Fredoka One</option>
                        <option value="'Zcool KuaiLe', cursive">ç«™é…·å¿«ä¹ä½“</option>
                        <option value="'Pacifico', cursive">Pacifico</option>
                        <option value="'Ma Shan Zheng', cursive">é©¬å–„æ”¿</option>
                        <option value="'Nunito', sans-serif">Nunito</option>
                    </select>
                </div>
            </div>

            <!-- è°ƒæ•´ -->
            <div id="tab-adjust" class="tab-content hidden">
                <div class="space-y-4">
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold w-10 text-gray-500">å¤§å°</span>
                        <input type="range" id="inp-size" min="20" max="250">
                        <span id="val-size" class="text-xs font-mono w-8 text-right text-blue-500">80</span>
                    </div>
                    <div class="flex items-center gap-3" id="row-width">
                        <span class="text-xs font-bold w-10 text-gray-500">åšåº¦</span>
                        <input type="range" id="inp-width" min="0" max="80">
                        <span id="val-width" class="text-xs font-mono w-8 text-right text-blue-500">20</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold w-10 text-gray-500">æ—‹è½¬</span>
                        <input type="range" id="inp-rot" min="-180" max="180">
                        <span id="val-rot" class="text-xs font-mono w-8 text-right text-blue-500">0</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold w-10 text-gray-500">é€æ˜</span>
                        <input type="range" id="inp-op" min="0" max="100">
                        <span id="val-op" class="text-xs font-mono w-8 text-right text-blue-500">100</span>
                    </div>
                    <div class="flex gap-4 pt-2">
                        <label class="flex items-center gap-2 text-xs font-bold text-gray-600">
                            <input type="checkbox" id="chk-outer" class="accent-blue-500"> æè¾¹
                        </label>
                        <label class="flex items-center gap-2 text-xs font-bold text-gray-600">
                            <input type="checkbox" id="chk-shadow" class="accent-blue-500"> æŠ•å½±
                        </label>
                    </div>
                </div>
            </div>

            <!-- å·¥å…· -->
            <div id="tab-tools" class="tab-content hidden">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="modifyLayer('up')" class="bg-gray-50 py-3 rounded-lg text-xs font-bold text-gray-600 active:bg-gray-200">ä¸Šç§»ä¸€å±‚</button>
                    <button onclick="modifyLayer('down')" class="bg-gray-50 py-3 rounded-lg text-xs font-bold text-gray-600 active:bg-gray-200">ä¸‹ç§»ä¸€å±‚</button>
                    <button onclick="modifyLayer('top')" class="bg-gray-50 py-3 rounded-lg text-xs font-bold text-gray-600 active:bg-gray-200">ç½®é¡¶</button>
                    <button onclick="modifyLayer('bottom')" class="bg-gray-50 py-3 rounded-lg text-xs font-bold text-gray-600 active:bg-gray-200">ç½®åº•</button>
                </div>
                <div class="border-t my-4"></div>
                <button onclick="duplicateItem()" class="w-full bg-blue-50 text-blue-600 py-3 rounded-lg text-xs font-bold mb-2">å¤åˆ¶å…ƒç´ </button>
                <button onclick="deleteItem()" class="w-full bg-red-50 text-red-500 py-3 rounded-lg text-xs font-bold">åˆ é™¤å…ƒç´ </button>
            </div>

        </div>
    </div>

    <!-- è´´çº¸æŠ½å±‰ -->
    <div id="drawer-stickers" class="drawer">
        <div class="drawer-header">
            <h3 class="font-bold">é€‰æ‹©è´´çº¸</h3>
            <button onclick="closeDrawer()" class="text-gray-400 p-2"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="drawer-content">
            <div id="sticker-list" class="grid grid-cols-5 gap-4"></div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒçŠ¶æ€ ---
        let items = [];
        let activeId = null;
        let zIndexCounter = 100;
        
        // è´´çº¸åº“
        const stickers = ['ğŸ˜Š','ğŸ˜‚','ğŸ¥°','ğŸ˜','ğŸ¤”','ğŸ˜´','ğŸ˜­','ğŸ˜¡','ğŸ‘','ğŸ‰','ğŸ”¥','â¤ï¸','ğŸŒ¸','ğŸŒ»','ğŸŒ¹','ğŸ€','ğŸ”','ğŸŸ','ğŸ°','â˜•','ğŸš—','âœˆï¸','ğŸš€','ğŸ ','ğŸ’¡','ğŸ','ğŸµ','ğŸ“·','ğŸ¶','ğŸ±'];

        // --- åˆå§‹åŒ– ---
        window.onload = () => {
            initCanvasSize();
            loadStickers();
            // å»¶æ—¶åŠ è½½é»˜è®¤æ–‡å­—
            setTimeout(() => addCloudText(), 100);
            updateNavState();
        };

        window.addEventListener('resize', initCanvasSize);

        function initCanvasSize() {
            const area = document.getElementById('app-canvas-area');
            const container = document.getElementById('canvas-container');
            const w = area.clientWidth - 40; // ç•™è¾¹è·
            const h = area.clientHeight - 40;
            const size = Math.min(w, h); // æ­£æ–¹å½¢
            container.style.width = size + 'px';
            container.style.height = size + 'px';
        }

        // --- å…ƒç´ åˆ›å»º ---
        function addCloudText() {
            createItem({
                type: 'text', text: 'Tim', 
                fontSize: 80, strokeWidth: 20,
                fill: '#3b82f6', stroke: '#ffffff', outer: '#93c5fd',
                hasOuter: true, hasShadow: false // é»˜è®¤æ— æŠ•å½±
            });
        }

        function createItem(props) {
            const id = 'item-' + Date.now();
            const item = {
                id, ...props,
                x: 80, y: 100, // åˆå§‹ä½ç½®
                scale: 1, rotation: 0, opacity: 100,
                zIndex: zIndexCounter++,
                fontFamily: "'Fredoka One', cursive"
            };
            items.push(item);
            renderItemDOM(item);
            setActiveItem(id);
            if(item.type === 'text') switchTab('style');
        }

        function addSticker(s) {
            createItem({
                type: 'sticker', text: s,
                fontSize: 120, strokeWidth: 0,
                fill: 'transparent', stroke: 'transparent',
                hasOuter: false, hasShadow: false
            });
            closeDrawer();
        }

        // --- æ¸²æŸ“é€»è¾‘ ---
        function renderItemDOM(item) {
            const el = document.createElement('div');
            el.id = item.id;
            el.className = 'draggable-item';
            
            // å†…éƒ¨ Canvas
            const canvas = document.createElement('canvas');
            el.appendChild(canvas);

            // æ§åˆ¶æ‰‹æŸ„
            const addHandle = (cls, icon) => {
                const d = document.createElement('div');
                d.className = `handle-btn ${cls}`;
                d.innerHTML = `<i class="fa-solid ${icon}"></i>`;
                el.appendChild(d);
                return d;
            };
            
            const delBtn = addHandle('delete-handle', 'fa-xmark');
            delBtn.ontouchstart = (e) => { e.stopPropagation(); deleteItem(); };
            
            const rotBtn = addHandle('rotate-handle', 'fa-rotate');
            rotBtn.ontouchstart = (e) => startRotate(e, item);
            
            const resBtn = addHandle('resize-handle', 'fa-expand');
            resBtn.ontouchstart = (e) => startResize(e, item);

            // è§¦æ‘¸ç§»åŠ¨
            el.addEventListener('touchstart', (e) => startDrag(e, item), {passive: false});
            // é¼ æ ‡å…¼å®¹
            el.addEventListener('mousedown', (e) => startDrag(e, item));

            document.getElementById('item-layer').appendChild(el);
            drawItemCanvas(item);
        }

        function drawItemCanvas(item) {
            const el = document.getElementById(item.id);
            if(!el) return;
            const canvas = el.querySelector('canvas');
            const ctx = canvas.getContext('2d');
            const dpr = 2; // 2å€å±å³å¯ï¼Œå¯¼å‡ºæ—¶ç”¨4å€

            // åº”ç”¨ CSS å˜æ¢
            el.style.left = item.x + 'px';
            el.style.top = item.y + 'px';
            el.style.transform = `rotate(${item.rotation}deg)`;
            el.style.zIndex = item.zIndex;
            el.style.opacity = item.opacity / 100;

            // æµ‹é‡
            const fontSize = item.fontSize;
            const strokeW = item.strokeWidth;
            const pad = strokeW + 20;
            
            ctx.font = `bold ${fontSize}px ${item.fontFamily}`;
            const metrics = ctx.measureText(item.text);
            const wText = metrics.width;
            const hText = fontSize * 1.2;
            
            const w = Math.ceil(wText + pad * 2);
            const h = Math.ceil(hText + pad * 2);

            canvas.width = w * dpr;
            canvas.height = h * dpr;
            ctx.scale(dpr, dpr);

            // ç»˜åˆ¶
            ctx.font = `bold ${fontSize}px ${item.fontFamily}`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            const cx = w/2, cy = h/2 + (fontSize * 0.05);
            
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';

            // æ¸…ç©º
            ctx.clearRect(0,0,w,h);

            if(item.type === 'sticker') {
                if(item.hasShadow) {
                    ctx.shadowColor = 'rgba(0,0,0,0.2)';
                    ctx.shadowBlur = 5; ctx.shadowOffsetX = 3; ctx.shadowOffsetY = 3;
                }
                ctx.fillText(item.text, cx, cy);
            } else {
                if(item.hasShadow) {
                    ctx.shadowColor = 'rgba(0,0,0,0.2)';
                    ctx.shadowBlur = 5; ctx.shadowOffsetX = 3; ctx.shadowOffsetY = 3;
                }
                if(item.hasOuter) {
                    ctx.lineWidth = strokeW + 12;
                    ctx.strokeStyle = item.outer;
                    ctx.strokeText(item.text, cx, cy);
                    ctx.shadowColor = 'transparent';
                }
                if(!item.hasOuter) ctx.shadowColor = 'transparent';
                ctx.lineWidth = strokeW;
                ctx.strokeStyle = item.stroke;
                ctx.strokeText(item.text, cx, cy);
                ctx.fillStyle = item.stroke;
                ctx.fillText(item.text, cx, cy);
                ctx.fillStyle = item.fill;
                ctx.fillText(item.text, cx, cy);
            }

            // è®¾ç½® DOM å°ºå¯¸
            const finalW = w * item.scale;
            const finalH = h * item.scale;
            canvas.style.width = finalW + 'px';
            canvas.style.height = finalH + 'px';
            el.style.width = finalW + 'px';
            el.style.height = finalH + 'px';
        }

        // --- äº¤äº’é€»è¾‘ ---
        let dragInfo = null;

        function startDrag(e, item) {
            if(e.target.className.includes('handle')) return;
            e.preventDefault(); e.stopPropagation();
            setActiveItem(item.id);
            const pt = getPoint(e);
            dragInfo = { type: 'move', item, startX: pt.x, startY: pt.y, initItemX: item.x, initItemY: item.y };
            bindMoveUp();
        }

        function startRotate(e, item) {
            e.preventDefault(); e.stopPropagation();
            const rect = document.getElementById(item.id).getBoundingClientRect();
            dragInfo = { type: 'rotate', item, cx: rect.left + rect.width/2, cy: rect.top + rect.height/2 };
            bindMoveUp();
        }

        function startResize(e, item) {
            e.preventDefault(); e.stopPropagation();
            const pt = getPoint(e);
            const rect = document.getElementById(item.id).getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.top + rect.height/2;
            const dist = Math.hypot(pt.x - cx, pt.y - cy);
            dragInfo = { type: 'resize', item, cx, cy, startDist: dist, startScale: item.scale };
            bindMoveUp();
        }

        function onMove(e) {
            if(!dragInfo) return;
            e.preventDefault();
            const pt = getPoint(e);
            const { item } = dragInfo;

            if(dragInfo.type === 'move') {
                item.x = dragInfo.initItemX + (pt.x - dragInfo.startX);
                item.y = dragInfo.initItemY + (pt.y - dragInfo.startY);
            } else if(dragInfo.type === 'rotate') {
                const angle = Math.atan2(pt.y - dragInfo.cy, pt.x - dragInfo.cx) * (180/Math.PI) + 90;
                item.rotation = angle;
                syncUI('rot', Math.round(angle));
            } else if(dragInfo.type === 'resize') {
                const dist = Math.hypot(pt.x - dragInfo.cx, pt.y - dragInfo.cy);
                item.scale = Math.max(0.2, dragInfo.startScale * (dist / dragInfo.startDist));
            }
            drawItemCanvas(item);
        }

        function onUp() {
            dragInfo = null;
            unbindMoveUp();
        }

        function getPoint(e) {
            return e.touches ? {x: e.touches[0].clientX, y: e.touches[0].clientY} : {x: e.clientX, y: e.clientY};
        }
        function bindMoveUp() {
            document.addEventListener('touchmove', onMove, {passive:false});
            document.addEventListener('touchend', onUp);
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
        }
        function unbindMoveUp() {
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('touchend', onUp);
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
        }

        // ç‚¹å‡»ç©ºç™½å–æ¶ˆ
        document.getElementById('app-canvas-area').addEventListener('click', (e) => {
            if(e.target.id === 'app-canvas-area' || e.target.id === 'canvas-container') {
                setActiveItem(null);
            }
        });

        // --- ç•Œé¢çŠ¶æ€ ---
        function setActiveItem(id) {
            document.querySelectorAll('.draggable-item').forEach(el => el.classList.remove('active'));
            activeId = id;
            updateNavState();
            
            if(id) {
                const el = document.getElementById(id);
                el.classList.add('active');
                const item = items.find(i => i.id === id);
                syncDrawer(item);
            } else {
                closeDrawer();
            }
        }

        function updateNavState() {
            const disabled = !activeId;
            document.querySelectorAll('.nav-item').forEach(n => {
                if(disabled) n.classList.add('disabled');
                else n.classList.remove('disabled');
            });
        }

        function switchTab(tab) {
            if(!activeId) return;
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('nav-'+tab).classList.add('active');
            
            openDrawer('main-drawer');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('tab-'+tab).classList.remove('hidden');
            
            const titles = { style:'å¤–è§‚æ ·å¼', adjust:'ç»†èŠ‚å‚æ•°', tools:'å·¥å…·ç®±' };
            document.getElementById('drawer-title').innerText = titles[tab];
        }

        function syncDrawer(item) {
            // è®¾ç½®å€¼
            const setVal = (id, val, textId) => {
                const el = document.getElementById(id);
                if(el) { el.value = val; if(textId) document.getElementById(textId).innerText = val; }
            };
            const setCol = (id, val, wellId) => {
                const el = document.getElementById(id);
                if(el) { el.value = val; document.getElementById(wellId).style.background = val; }
            };

            setVal('inp-text', item.text);
            setVal('inp-size', item.fontSize, 'val-size');
            setVal('inp-width', item.strokeWidth, 'val-width');
            setVal('inp-rot', Math.round(item.rotation), 'val-rot');
            setVal('inp-op', item.opacity, 'val-op');
            
            setCol('inp-fill', item.fill, 'well-fill');
            setCol('inp-stroke', item.stroke, 'well-stroke');
            setCol('inp-outer', item.outer, 'well-outer');
            
            document.getElementById('chk-outer').checked = item.hasOuter;
            document.getElementById('chk-shadow').checked = item.hasShadow;

            // è´´çº¸éšè—éƒ¨åˆ†é€‰é¡¹
            const isSticker = item.type === 'sticker';
            const hideIds = ['text-input-group', 'color-group', 'font-group', 'row-width'];
            hideIds.forEach(id => document.getElementById(id).style.display = isSticker ? 'none' : 'block');
        }

        // --- å±æ€§ä¿®æ”¹ ---
        const updateItem = (key, val) => {
            if(!activeId) return;
            const item = items.find(i => i.id === activeId);
            item[key] = val;
            drawItemCanvas(item);
        };
        
        const syncUI = (type, val) => {
            if(type === 'rot') {
                document.getElementById('inp-rot').value = val;
                document.getElementById('val-rot').innerText = val;
            }
        };

        // ç»‘å®šè¾“å…¥
        document.getElementById('inp-text').oninput = e => updateItem('text', e.target.value);
        document.getElementById('inp-size').oninput = e => { 
            updateItem('fontSize', parseInt(e.target.value)); 
            document.getElementById('val-size').innerText = e.target.value; 
        };
        document.getElementById('inp-width').oninput = e => {
            updateItem('strokeWidth', parseInt(e.target.value));
            document.getElementById('val-width').innerText = e.target.value;
        };
        document.getElementById('inp-rot').oninput = e => {
            updateItem('rotation', parseInt(e.target.value));
            document.getElementById('val-rot').innerText = e.target.value;
        };
        document.getElementById('inp-op').oninput = e => {
            updateItem('opacity', parseInt(e.target.value));
            document.getElementById('val-op').innerText = e.target.value;
        };
        
        ['fill','stroke','outer'].forEach(k => {
            document.getElementById('inp-'+k).oninput = e => {
                updateItem(k, e.target.value);
                document.getElementById('well-'+k).style.background = e.target.value;
            };
        });

        document.getElementById('chk-outer').onchange = e => updateItem('hasOuter', e.target.checked);
        document.getElementById('chk-shadow').onchange = e => updateItem('hasShadow', e.target.checked);
        document.getElementById('inp-font').onchange = e => updateItem('fontFamily', e.target.value);

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function modifyLayer(action) {
            if(!activeId) return;
            const item = items.find(i => i.id === activeId);
            if(action === 'top') item.zIndex = zIndexCounter++;
            if(action === 'bottom') item.zIndex = 1; // ç®€å•ç½®åº•
            if(action === 'up') item.zIndex++;
            if(action === 'down') item.zIndex--;
            drawItemCanvas(item);
            setActiveItem(null); // å–æ¶ˆé€‰ä¸­ä»¥ä¾¿è§‚å¯Ÿ
            closeDrawer();
        }

        function duplicateItem() {
            if(!activeId) return;
            const src = items.find(i => i.id === activeId);
            const copy = JSON.parse(JSON.stringify(src));
            copy.id = 'item-' + Date.now();
            copy.x += 30; copy.y += 30; copy.zIndex = zIndexCounter++;
            items.push(copy);
            renderItemDOM(copy);
            setActiveItem(copy.id);
        }

        function deleteItem() {
            if(!activeId) return;
            document.getElementById(activeId).remove();
            items = items.filter(i => i.id !== activeId);
            setActiveItem(null);
        }

        function loadStickers() {
            const list = document.getElementById('sticker-list');
            const emojis = ['ğŸ˜Š','ğŸ¥°','ğŸ˜','ğŸ¤”','ğŸ˜­','ğŸ˜¡','ğŸ‘','ğŸ‰','ğŸ”¥','â¤ï¸','ğŸŒ¸','ğŸŒ»','ğŸ”','ğŸŸ','ğŸš—','ğŸš€'];
            emojis.forEach(s => {
                const btn = document.createElement('button');
                btn.className = "text-3xl p-2 active:scale-90 transition";
                btn.textContent = s;
                btn.onclick = () => addSticker(s);
                list.appendChild(btn);
            });
        }

        function openDrawer(id) {
            document.querySelectorAll('.drawer').forEach(d => d.classList.remove('open'));
            document.getElementById(id).classList.add('open');
        }
        function closeDrawer() {
            document.querySelectorAll('.drawer').forEach(d => d.classList.remove('open'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        }

        // --- å¯¼å‡º (Canvas é‡ç»˜æ³•) ---
        async function exportImage() {
            setActiveItem(null); closeDrawer();
            
            // åˆ›å»ºé«˜æ¸… Canvas
            const canvas = document.createElement('canvas');
            const container = document.getElementById('canvas-container');
            const w = container.offsetWidth;
            const h = container.offsetHeight;
            const dpr = 4; // 4Kçº§
            
            canvas.width = w * dpr;
            canvas.height = h * dpr;
            const ctx = canvas.getContext('2d');
            
            // 1. å¡«å……ç™½åº•
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.scale(dpr, dpr);

            // 2. æŒ‰å±‚çº§æ’åºç»˜åˆ¶
            const sorted = [...items].sort((a,b) => a.zIndex - b.zIndex);
            
            for(const item of sorted) {
                // è®¡ç®—ç»˜åˆ¶å‚æ•° (é€»è¾‘ä¸ drawItemCanvas ä¸€è‡´)
                const fontSize = item.fontSize;
                const strokeW = item.strokeWidth;
                const pad = strokeW + 20;
                
                ctx.font = `bold ${fontSize}px ${item.fontFamily}`;
                const metrics = ctx.measureText(item.text);
                const wText = metrics.width;
                const hText = fontSize * 1.2;
                
                const iw = Math.ceil(wText + pad * 2);
                const ih = Math.ceil(hText + pad * 2);
                
                // è®¡ç®—ä¸­å¿ƒåæ ‡
                const finalW = iw * item.scale;
                const finalH = ih * item.scale;
                const cx = item.x + finalW / 2;
                const cy = item.y + finalH / 2;

                ctx.save();
                ctx.translate(cx, cy);
                ctx.rotate(item.rotation * Math.PI / 180);
                ctx.scale(item.scale, item.scale);
                ctx.globalAlpha = item.opacity / 100;
                ctx.translate(-iw/2, -ih/2);

                // Draw Text
                const drawCx = iw/2;
                const drawCy = ih/2 + (fontSize * 0.05);
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.lineJoin = 'round'; ctx.lineCap = 'round';

                if(item.type === 'sticker') {
                    ctx.font = `bold ${fontSize}px sans-serif`;
                    if(item.hasShadow) {
                        ctx.shadowColor = 'rgba(0,0,0,0.2)';
                        ctx.shadowBlur = 5; ctx.shadowOffsetX = 3; ctx.shadowOffsetY = 3;
                    }
                    ctx.fillText(item.text, drawCx, drawCy);
                } else {
                    if(item.hasShadow) {
                        ctx.shadowColor = 'rgba(0,0,0,0.2)';
                        ctx.shadowBlur = 5; ctx.shadowOffsetX = 3; ctx.shadowOffsetY = 3;
                    }
                    if(item.hasOuter) {
                        ctx.lineWidth = strokeW + 12;
                        ctx.strokeStyle = item.outer;
                        ctx.strokeText(item.text, drawCx, drawCy);
                        ctx.shadowColor = 'transparent';
                    }
                    if(!item.hasOuter) ctx.shadowColor = 'transparent';
                    ctx.lineWidth = strokeW;
                    ctx.strokeStyle = item.stroke;
                    ctx.strokeText(item.text, drawCx, drawCy);
                    ctx.fillStyle = item.stroke;
                    ctx.fillText(item.text, drawCx, drawCy);
                    ctx.fillStyle = item.fill;
                    ctx.fillText(item.text, drawCx, drawCy);
                }
                ctx.restore();
            }

            // 3. ä¸‹è½½
            const link = document.createElement('a');
            link.download = `tim_cloud_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>
</html>
