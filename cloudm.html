<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº‘æœµå­—ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Zcool+KuaiLe&family=Pacifico&family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@400;700&family=Nunito:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --header-h: 60px;
            --nav-h: 70px; 
        }

        body {
            font-family: 'Fredoka One', 'Zcool KuaiLe', sans-serif;
            background-color: #f3f4f6;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
        }

        /* --- 1. é¡¶éƒ¨æ  --- */
        #app-header {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: var(--header-h);
            background: white;
            z-index: 50; 
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* --- 2. åº•éƒ¨æ  --- */
        #app-bottom-nav {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: var(--nav-h);
            background: white;
            z-index: 6000; 
            border-top: 1px solid #e2e8f0;
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- 3. ç”»å¸ƒåŒºåŸŸ --- */
        #canvas-wrapper {
            position: absolute;
            top: var(--header-h);
            bottom: var(--nav-h);
            left: 0; right: 0;
            background: #f1f5f9;
            z-index: 1; 
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }

        #canvas-container {
            background-color: white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        /* --- 4. æŠ½å±‰ --- */
        .drawer {
            position: absolute;
            left: 0; right: 0;
            bottom: var(--nav-h); 
            height: 35vh; 
            min-height: 280px; 
            max-height: 400px;
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
            z-index: 5000; 
            transform: translateY(120%); 
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column;
            border-bottom: 1px solid #f1f5f9;
        }
        .drawer.open { transform: translateY(0); }

        .drawer-header {
            flex-shrink: 0; padding: 10px 16px; border-bottom: 1px solid #f1f5f9;
            display: flex; justify-content: space-between; align-items: center;
        }
        .drawer-content {
            flex: 1; overflow-y: auto; padding: 12px 16px;
        }

        /* --- ç»„ä»¶æ ·å¼ --- */
        .top-btn {
            display: flex; align-items: center; gap: 4px; padding: 8px 10px;
            border-radius: 8px; font-size: 11px; font-weight: bold;
            background: #eff6ff; color: #3b82f6; transition: all 0.1s;
        }
        .top-btn:active { transform: scale(0.95); background: #dbeafe; }
        .top-btn.save { background: #3b82f6; color: white; margin-left: auto; }
        .top-btn.sticker { background: #fff7ed; color: #f59e0b; }
        .top-btn.image { background: #f0fdf4; color: #16a34a; }

        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; width: 60px; gap: 2px;
            color: #94a3b8; font-size: 10px; font-weight: bold;
            transition: color 0.2s;
        }
        .nav-item i { font-size: 22px; }
        .nav-item.active { color: #3b82f6; }
        .nav-item:active { transform: scale(0.95); } 
        .nav-item.disabled { opacity: 0.3; filter: grayscale(1); pointer-events: none; }

        /* å…ƒç´ æ ·å¼ */
        .draggable-item {
            position: absolute; padding: 0; border: 1px dashed transparent;
            transform-origin: center center;
        }
        .draggable-item.active { border-color: #3b82f6; z-index: 1000; }

        .handle-btn {
            position: absolute; width: 30px; height: 30px; background: white;
            border: 2px solid #3b82f6; border-radius: 50%;
            display: none; z-index: 2000;
            align-items: center; justify-content: center; color: #3b82f6; font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .draggable-item.active .handle-btn { display: flex; }
        .rotate-handle { top: -40px; left: 50%; transform: translateX(-50%); color: #10b981; border-color: #10b981; }
        .rotate-handle::after { content:''; position: absolute; top: 28px; width: 1px; height: 15px; background: #10b981; }
        .resize-handle { bottom: -15px; right: -15px; }
        .delete-handle { top: -15px; left: -15px; color: #ef4444; border-color: #ef4444; }

        /* UI å°éƒ¨ä»¶ */
        .color-well { width: 36px; height: 36px; border-radius: 8px; border: 2px solid #e2e8f0; position: relative; overflow: hidden; }
        .color-well input { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; opacity: 0; cursor: pointer; }
        
        .prop-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .prop-label { width: 50px; font-size: 11px; font-weight: bold; color: #64748b; }
        .prop-val { width: 30px; font-size: 11px; font-family: monospace; color: #3b82f6; text-align: right; }
        
        input[type="range"] { flex: 1; height: 6px; background: #e2e8f0; border-radius: 3px; outline: none; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: white; border: 2px solid #3b82f6; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .palette-btn { width: 40px; height: 40px; flex-shrink: 0; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼  Input -->
    <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleImageUpload(event)">

    <!-- 1. é¡¶éƒ¨æ  -->
    <header id="app-header">
        <div class="flex gap-2 overflow-x-auto hide-scrollbar">
            <button onclick="addCloudText()" class="top-btn">
                <i class="fa-solid fa-font"></i> æ–‡å­—
            </button>
            <button onclick="openDrawer('drawer-stickers')" class="top-btn sticker">
                <i class="fa-regular fa-face-smile"></i> è´´çº¸
            </button>
            <button onclick="document.getElementById('file-input').click()" class="top-btn image">
                <i class="fa-regular fa-image"></i> å›¾ç‰‡
            </button>
        </div>
        <button onclick="exportImage()" class="top-btn save flex-shrink-0">
            <i class="fa-solid fa-download"></i> ä¿å­˜
        </button>
    </header>

    <!-- 2. ç”»å¸ƒåŒºåŸŸ -->
    <div id="canvas-wrapper">
        <div id="canvas-container">
            <!-- çº¯ç™½èƒŒæ™¯ -->
            <div class="absolute inset-0 bg-white"></div>
            <!-- ç½‘æ ¼ -->
            <div id="grid-layer" class="absolute inset-0 pointer-events-none opacity-10" 
                 style="background-image: linear-gradient(#94a3b8 1px, transparent 1px), linear-gradient(90deg, #94a3b8 1px, transparent 1px); background-size: 20px 20px;">
            </div>
            <!-- å…ƒç´ å±‚ -->
            <div id="item-layer" class="absolute inset-0 w-full h-full overflow-hidden"></div>
        </div>
    </div>

    <!-- 3. åº•éƒ¨å¯¼èˆªæ  -->
    <nav id="app-bottom-nav">
        <button onclick="switchTab('style')" class="nav-item" id="nav-style">
            <i class="fa-solid fa-paintbrush"></i> æ ·å¼
        </button>
        <button onclick="switchTab('adjust')" class="nav-item" id="nav-adjust">
            <i class="fa-solid fa-sliders"></i> è°ƒæ•´
        </button>
        <button onclick="switchTab('tools')" class="nav-item" id="nav-tools">
            <i class="fa-solid fa-layer-group"></i> å·¥å…·
        </button>
    </nav>

    <!-- 4. å±æ€§ç¼–è¾‘æŠ½å±‰ -->
    <div id="main-drawer" class="drawer">
        <div class="drawer-header">
            <h3 class="font-bold text-gray-800 text-sm" id="drawer-title">å±æ€§</h3>
            <button onclick="closeDrawer()" class="text-gray-400 p-2"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="drawer-content">
            
            <!-- Tab: æ ·å¼ -->
            <div id="tab-style" class="tab-content hidden">
                <div id="text-input-group" class="mb-4">
                    <label class="text-xs text-gray-400 font-bold mb-1 block">å†…å®¹</label>
                    <input type="text" id="inp-text" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                </div>
                
                <div class="mb-4" id="palette-group">
                    <label class="text-xs text-gray-400 font-bold mb-2 block">ä¸€é”®é…è‰²</label>
                    <div class="flex gap-3 overflow-x-auto hide-scrollbar p-1" id="palette-list"></div>
                </div>

                <div id="color-group">
                    <label class="text-xs text-gray-400 font-bold mb-2 block">è‡ªå®šä¹‰é¢œè‰²</label>
                    <div class="flex justify-around bg-gray-50 p-2 rounded-xl border border-gray-100">
                        <div class="flex flex-col items-center gap-1" id="wrap-fill">
                            <div class="color-well" style="background:#3b82f6" id="well-fill">
                                <input type="color" id="inp-fill">
                            </div>
                            <span class="text-[10px] text-gray-500">å­—è‰²</span>
                        </div>
                        <div class="flex flex-col items-center gap-1" id="wrap-stroke">
                            <div class="color-well" style="background:#ffffff" id="well-stroke">
                                <input type="color" id="inp-stroke">
                            </div>
                            <span class="text-[10px] text-gray-500" id="lbl-stroke">äº‘æœµ</span>
                        </div>
                        <div class="flex flex-col items-center gap-1" id="wrap-outer">
                            <div class="color-well" style="background:#93c5fd" id="well-outer">
                                <input type="color" id="inp-outer">
                            </div>
                            <span class="text-[10px] text-gray-500">è½®å»“</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: è°ƒæ•´ -->
            <div id="tab-adjust" class="tab-content hidden">
                <div class="flex items-center justify-between bg-gray-50 p-2 rounded-lg mb-4 border border-gray-100" id="font-group">
                    <span class="text-xs font-bold text-gray-600">å­—ä½“æ ·å¼</span>
                    <select id="inp-font" class="bg-white border border-gray-200 text-xs rounded px-2 py-1 outline-none text-gray-600 w-32">
                        <option value="'Fredoka One', cursive">Fredoka One</option>
                        <option value="'Zcool KuaiLe', cursive">ç«™é…·å¿«ä¹ä½“</option>
                        <option value="'Pacifico', cursive">Pacifico</option>
                        <option value="'Ma Shan Zheng', cursive">é©¬å–„æ”¿</option>
                        <option value="'Nunito', sans-serif">Nunito</option>
                    </select>
                </div>

                <div class="prop-row">
                    <span class="prop-label" id="lbl-size">å­—å·</span>
                    <input type="range" id="inp-size" min="20" max="250">
                    <span class="prop-val" id="val-size">80</span>
                </div>
                
                <div class="prop-row" id="row-width">
                    <span class="prop-label" id="lbl-width">åšåº¦</span>
                    <input type="range" id="inp-width" min="0" max="80">
                    <span class="prop-val" id="val-width">20</span>
                </div>
                
                <div class="prop-row hidden" id="row-radius">
                    <span class="prop-label">åœ†è§’</span>
                    <input type="range" id="inp-radius" min="0" max="50">
                    <span class="prop-val" id="val-radius">15</span>
                </div>

                <div class="prop-row">
                    <span class="prop-label">æ—‹è½¬</span>
                    <input type="range" id="inp-rot" min="-180" max="180">
                    <span class="prop-val" id="val-rot">0Â°</span>
                </div>
                <div class="prop-row">
                    <span class="prop-label">é€æ˜</span>
                    <input type="range" id="inp-op" min="0" max="100">
                    <span class="prop-val" id="val-op">100</span>
                </div>

                <div class="flex gap-4 pt-2">
                    <label class="flex items-center gap-2 text-xs font-bold text-gray-600" id="opt-outer">
                        <input type="checkbox" id="chk-outer" class="accent-blue-500 w-4 h-4"> 
                        <span id="txt-outer">è½®å»“æè¾¹</span>
                    </label>
                    <label class="flex items-center gap-2 text-xs font-bold text-gray-600">
                        <input type="checkbox" id="chk-shadow" class="accent-blue-500 w-4 h-4"> æŠ•å½±
                    </label>
                </div>
            </div>

            <!-- Tab: å·¥å…· -->
            <div id="tab-tools" class="tab-content hidden">
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="modifyLayer('up')" class="bg-gray-50 py-3 rounded-lg text-xs font-bold text-gray-600 active:bg-gray-200">ä¸Šç§»ä¸€å±‚</button>
                    <button onclick="modifyLayer('down')" class="bg-gray-50 py-3 rounded-lg text-xs font-bold text-gray-600 active:bg-gray-200">ä¸‹ç§»ä¸€å±‚</button>
                    <button onclick="modifyLayer('top')" class="bg-gray-50 py-3 rounded-lg text-xs font-bold text-gray-600 active:bg-gray-200">ç½®é¡¶</button>
                    <button onclick="modifyLayer('bottom')" class="bg-gray-50 py-3 rounded-lg text-xs font-bold text-gray-600 active:bg-gray-200">ç½®åº•</button>
                </div>
                <div class="border-t border-gray-100 my-4"></div>
                <button onclick="duplicateItem()" class="w-full bg-blue-50 text-blue-600 py-3 rounded-lg text-xs font-bold active:bg-blue-100 mb-3 flex items-center justify-center gap-2">
                    <i class="fa-regular fa-copy"></i> å¤åˆ¶å…ƒç´ 
                </button>
                <button onclick="deleteActiveItem()" class="w-full bg-red-50 text-red-500 py-3 rounded-lg text-xs font-bold active:bg-red-100 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-trash-can"></i> åˆ é™¤å…ƒç´ 
                </button>
            </div>
        </div>
    </div>

    <!-- 5. è´´çº¸æŠ½å±‰ -->
    <div id="drawer-stickers" class="drawer">
        <div class="drawer-header">
            <h3 class="font-bold text-sm">é€‰æ‹©è´´çº¸</h3>
            <button onclick="closeDrawer()" class="text-gray-400 p-2"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="drawer-content">
            <div class="flex gap-2 overflow-x-auto hide-scrollbar mb-4 border-b border-gray-100 pb-2">
                <button onclick="filterStickers('face')" class="bg-yellow-50 text-yellow-600 px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap">ğŸ˜€ è¡¨æƒ…</button>
                <button onclick="filterStickers('nature')" class="bg-green-50 text-green-600 px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap">ğŸŒ¸ è‡ªç„¶</button>
                <button onclick="filterStickers('food')" class="bg-orange-50 text-orange-600 px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap">ğŸ” ç¾é£Ÿ</button>
                <button onclick="filterStickers('activity')" class="bg-purple-50 text-purple-600 px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap">âš½ ç©ä¹</button>
                <button onclick="filterStickers('travel')" class="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap">ğŸš— æ—…è¡Œ</button>
                <button onclick="filterStickers('objects')" class="bg-gray-100 text-gray-600 px-3 py-1.5 rounded-lg text-xs font-bold whitespace-nowrap">ğŸ’¡ ç‰©ä½“</button>
            </div>
            <div id="sticker-list" class="grid grid-cols-5 gap-4 pb-10"></div>
        </div>
    </div>

    <script>
        let items = [];
        let activeId = null;
        let zIndexCounter = 100;
        let isAutoFit = true;

        const palettes = [
            { fill: '#ffecd2', stroke: '#ffffff', outer: '#ff9a9e' },
            { fill: '#e0c3fc', stroke: '#ffffff', outer: '#60a5fa' },
            { fill: '#d4fc79', stroke: '#ffffff', outer: '#4ade80' },
            { fill: '#f6d365', stroke: '#ffffff', outer: '#fb923c' },
            { fill: '#ff9a9e', stroke: '#ffffff', outer: '#f472b6' },
            { fill: '#374151', stroke: '#ffffff', outer: '#000000' },
        ];

        const stickers = {
            face: ['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ¤£','ğŸ˜‚','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜Š','ğŸ˜‡','ğŸ¥°','ğŸ˜','ğŸ¤©','ğŸ˜˜','ğŸ˜—','â˜ºï¸','ğŸ˜š','ğŸ˜™','ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ˜','ğŸ¤‘','ğŸ¤—','ğŸ¤­','ğŸ¤«','ğŸ¤”','ğŸ¤','ğŸ¤¨','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬','ğŸ¤¥','ğŸ˜Œ','ğŸ˜”','ğŸ˜ª','ğŸ¤¤','ğŸ˜´','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ¥µ','ğŸ¥¶','ğŸ¥´','ğŸ˜µ','ğŸ¤¯','ğŸ¤ ','ğŸ¥³','ğŸ˜','ğŸ¤“','ğŸ§','ğŸ˜•','ğŸ˜Ÿ','ğŸ™','â˜¹ï¸','ğŸ˜®','ğŸ˜¯','ğŸ˜²','ğŸ˜³','ğŸ¥º','ğŸ˜¦','ğŸ˜§','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜¢','ğŸ˜­','ğŸ˜±','ğŸ˜–','ğŸ˜£','ğŸ˜','ğŸ˜“','ğŸ˜©','ğŸ˜«','ğŸ¥±','ğŸ˜¤','ğŸ˜¡','ğŸ˜ ','ğŸ¤¬','ğŸ˜ˆ','ğŸ‘¿','ğŸ’€','â˜ ï¸','ğŸ’©','ğŸ¤¡','ğŸ‘¹','ğŸ‘º','ğŸ‘»','ğŸ‘½','ğŸ‘¾','ğŸ¤–','ğŸ˜º','ğŸ˜¸','ğŸ˜¹','ğŸ˜»','ğŸ˜¼','ğŸ˜½','ğŸ™€','ğŸ˜¿','ğŸ˜¾'],
            nature: ['ğŸŒ¸','ğŸ’','ğŸŒ·','ğŸŒ¹','ğŸ¥€','ğŸŒº','ğŸ’','ğŸ“','ğŸ','ğŸ','ğŸ¥­','ğŸ¥¥','ğŸ¥','ğŸ¥‘','ğŸ†','ğŸ¥”','ğŸ¥•','ğŸŒ½','ğŸŒ¶ï¸','ğŸ¥’','ğŸ¥¬','ğŸ¥¦','ğŸ§„','ğŸ§…','ğŸ„','ğŸ¥œ','ğŸŒ°','ğŸ','ğŸ¥','ğŸ¥–','ğŸ¥¨','ğŸ¥¯','ğŸ¥','ğŸ§‡','ğŸ§€','ğŸ–','ğŸ—','ğŸ¥©','ğŸ¥“','ğŸ”','ğŸŸ','ğŸ•','ğŸŒ­','ğŸ¥ª','ğŸŒ®','ğŸŒ¯','ğŸ¥™','ğŸ§†','ğŸ¥š','ğŸ³','ğŸ¥˜','ğŸ²','ğŸ¥£','ğŸ¥—','ğŸ¿','ğŸ§ˆ','ğŸ§‚','ğŸ¥«','ğŸ±','ğŸ˜','ğŸ™','ğŸš','ğŸ›','ğŸœ','ğŸ','ğŸ ','ğŸ¢','ğŸ£','ğŸ¤','ğŸ¥','ğŸ¥®','ğŸ¡','ğŸ¥Ÿ','ğŸ¥ ','ğŸ¥¡','ğŸ¦€','ğŸ¦','ğŸ¦','ğŸ¦‘','ğŸ¦ª','ğŸ¦','ğŸ§','ğŸ¨','ğŸ©'],
            food: ['ğŸª','ğŸ‚','ğŸ°','ğŸ§','ğŸ¥§','ğŸ«','ğŸ¬','ğŸ­','ğŸ®','ğŸ¯','ğŸ¼','ğŸ¥›','â˜•','ğŸµ','ğŸ¶','ğŸ¾','ğŸ·','ğŸ¸','ğŸ¹','ğŸº','ğŸ»','ğŸ¥‚','ğŸ¥ƒ','ğŸ¥¤','ğŸ§ƒ','ğŸ§‰','ğŸ§Š','ğŸ¥¢','ğŸ½ï¸','ğŸ´','ğŸ¥„','ğŸ”ª','ğŸº'],
            activity: ['âš½','ğŸ€','ğŸˆ','âš¾','ğŸ¥','ğŸ¾','ğŸ','ğŸ‰','ğŸ¥','ğŸ±','ğŸª€','ğŸ“','ğŸ¸','ğŸ’','ğŸ‘','ğŸ¥','ğŸ','ğŸ¥…','â›³','ğŸª','ğŸ¹','ğŸ£','ğŸ¤¿','ğŸ¥Š','ğŸ¥‹','ğŸ½','ğŸ›¹','ğŸ›·','â›¸ï¸','ğŸ¥Œ','ğŸ¿','â›·ï¸','ğŸ‚','ğŸª‚','ğŸ‹ï¸','ğŸ¤¼','ğŸ¤¸','â›¹ï¸','ğŸ¤º','ğŸ¤¾','ğŸŒï¸','ğŸ‡'],
            travel: ['ğŸš—','ğŸš•','ğŸš™','ğŸšŒ','ğŸš','ğŸï¸','ğŸš“','ğŸš‘','ğŸš’','ğŸš','ğŸšš','ğŸš›','ğŸšœ','ğŸï¸','ğŸ›µ','ğŸ¦½','ğŸ¦¼','ğŸ›º','ğŸš²','ğŸ›´','ğŸ›¹','ğŸš','ğŸ›£ï¸','ğŸ›¤ï¸','ğŸ›¢ï¸','â›½','ğŸš¨','ğŸš¥','ğŸš¦','ğŸ›‘','ğŸš§','âš“','â›µ','ğŸ›¶','ğŸš¤','ğŸ›³ï¸','â›´ï¸','ğŸ›¥ï¸','ğŸš¢','âœˆï¸','ğŸ›©ï¸','ğŸ›«'],
            objects: ['âŒš','ğŸ“±','ğŸ“²','ğŸ’»','âŒ¨ï¸','ğŸ–¥ï¸','ğŸ–¨ï¸','ğŸ–±ï¸','ğŸ–²ï¸','ğŸ•¹ï¸','ğŸ—œï¸','ğŸ’½','ğŸ’¾','ğŸ’¿','ğŸ“€','ğŸ“¼','ğŸ“·','ğŸ“¸','ğŸ“¹','ğŸ¥','ğŸ“½ï¸','ğŸï¸','ğŸ“','â˜ï¸','ğŸ“Ÿ','ğŸ“ ','ğŸ“º','ğŸ“»','ğŸ™ï¸','ğŸšï¸','ğŸ›ï¸','ğŸ§­','â±ï¸','â²ï¸','â°','ğŸ•°ï¸','âŒ›','â³','ğŸ“¡','ğŸ”‹','ğŸ”Œ','ğŸ’¡']
        };

        window.onload = () => {
            initCanvasSize();
            filterStickers('face');
            initPalettes();
            setTimeout(() => addCloudText(), 100);
            updateNavState();
        };

        window.addEventListener('resize', initCanvasSize);

        function initCanvasSize() {
            const wrapper = document.getElementById('canvas-wrapper');
            const container = document.getElementById('canvas-container');
            const w = wrapper.clientWidth - 20; 
            const h = wrapper.clientHeight - 20;
            const size = Math.min(w, h);
            container.style.width = size + 'px';
            container.style.height = size + 'px';
        }

        // --- æ ¸å¿ƒæ“ä½œ ---
        function addCloudText() {
            createItem('text', 'Tim');
        }
        function addSticker(s) {
            createItem('sticker', s);
            closeDrawer();
        }
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const img = new Image();
                img.onload = () => {
                    // Smart resizing
                    let w = img.width, h = img.height;
                    const max = 250;
                    if(w > h && w > max) { h *= max/w; w = max; }
                    else if(h > max) { w *= max/h; h = max; }
                    createItem('image', evt.target.result, w, h);
                };
                img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
            e.target.value = ''; // reset
        }

        function createItem(type, content, w, h) {
            const id = 'item-' + Date.now();
            const base = {
                id, type,
                x: 100 + (items.length * 5) % 50, 
                y: 100 + (items.length * 5) % 50,
                scale: 1, rotation: 0, opacity: 100, zIndex: zIndexCounter++,
                hasShadow: false,
                // Default props
                strokeWidth: 0, strokeColor: '#ffffff',
                fillColor: 'transparent', outerColor: '#93c5fd',
                borderRadius: 15,
                hasOuter: false
            };

            if(type === 'text') {
                base.text = content;
                base.fontFamily = "'Fredoka One', cursive";
                base.fontSize = 80;
                base.fillColor = '#3b82f6';
                base.strokeWidth = 20;
                base.hasOuter = true;
            } else if (type === 'sticker') {
                base.text = content;
                base.fontSize = 120;
            } else if (type === 'image') {
                base.src = content;
                base.width = w; base.height = h;
                base.strokeWidth = 10;
                base.strokeColor = '#ffffff';
                base.hasOuter = true; // Image border
            }

            items.push(base);
            renderItemDOM(base);
            setActiveItem(id);
            if(type === 'text') switchTab('style');
            else switchTab('adjust');
        }

        // --- æ¸²æŸ“ ---
        function renderItemDOM(item) {
            const el = document.createElement('div');
            el.id = item.id;
            el.className = 'draggable-item';
            el.style.zIndex = item.zIndex;

            const canvas = document.createElement('canvas');
            el.appendChild(canvas);

            // Controls
            const btn = (cls, icon) => `<div class="handle-btn ${cls}"><i class="fa-solid ${icon}"></i></div>`;
            el.innerHTML += btn('delete-handle', 'fa-xmark') + btn('rotate-handle', 'fa-rotate') + btn('resize-handle', 'fa-expand');

            // Events
            const delBtn = el.querySelector('.delete-handle');
            delBtn.ontouchstart = (e) => { e.stopPropagation(); deleteActiveItem(); };
            delBtn.onmousedown = (e) => { e.stopPropagation(); deleteActiveItem(); }; 

            const rotBtn = el.querySelector('.rotate-handle');
            rotBtn.ontouchstart = (e) => startRotate(e, item);
            rotBtn.onmousedown = (e) => startRotate(e, item);

            const resBtn = el.querySelector('.resize-handle');
            resBtn.ontouchstart = (e) => startResize(e, item);
            resBtn.onmousedown = (e) => startResize(e, item);

            el.addEventListener('touchstart', (e) => startDrag(e, item), {passive: false});
            el.addEventListener('mousedown', (e) => startDrag(e, item));

            document.getElementById('item-layer').appendChild(el);
            drawItemCanvas(item);
        }

        function drawItemCanvas(item) {
            const el = document.getElementById(item.id);
            if(!el) return;
            const canvas = el.querySelector('canvas');
            const ctx = canvas.getContext('2d');
            const dpr = 2; 

            el.style.transform = `rotate(${item.rotation}deg)`;
            el.style.left = item.x + 'px';
            el.style.top = item.y + 'px';
            el.style.zIndex = item.zIndex;
            el.style.opacity = item.opacity / 100;

            const strokeW = parseInt(item.strokeWidth || 0);
            const pad = strokeW + 20;

            let w, h, cx, cy;

            if (item.type === 'image') {
                w = item.width + pad*2;
                h = item.height + pad*2;
            } else {
                const isSticker = item.type === 'sticker';
                const font = isSticker ? "sans-serif" : item.fontFamily;
                ctx.font = `bold ${item.fontSize}px ${font}`;
                const metrics = ctx.measureText(item.text);
                const wText = metrics.width;
                const hText = item.fontSize * 1.2;
                w = Math.ceil(wText + pad * 2);
                h = Math.ceil(hText + pad * 2);
            }

            canvas.width = w * dpr; canvas.height = h * dpr;
            ctx.scale(dpr, dpr);
            
            cx = w/2; cy = h/2;
            if(item.type !== 'image') cy += (item.fontSize * 0.05);

            ctx.lineJoin = 'round'; ctx.lineCap = 'round';
            ctx.clearRect(0,0,w,h);

            // Draw
            if(item.type === 'image') {
                const img = new Image();
                img.src = item.src;
                const radius = item.borderRadius;
                
                if(item.hasShadow) {
                    ctx.shadowColor = 'rgba(0,0,0,0.2)';
                    ctx.shadowBlur=5; ctx.shadowOffsetX=3; ctx.shadowOffsetY=3;
                    ctx.fillStyle = 'black';
                    ctx.roundRect(pad, pad, item.width, item.height, radius);
                    ctx.fill();
                    ctx.shadowColor = 'transparent';
                }

                if(item.hasOuter && strokeW > 0) {
                     ctx.lineWidth = strokeW;
                     ctx.strokeStyle = item.strokeColor;
                     ctx.beginPath();
                     ctx.roundRect(pad - strokeW/2, pad - strokeW/2, item.width + strokeW, item.height + strokeW, radius + strokeW/2);
                     ctx.stroke();
                }

                ctx.beginPath();
                ctx.roundRect(pad, pad, item.width, item.height, radius);
                ctx.save();
                ctx.clip();
                ctx.drawImage(img, pad, pad, item.width, item.height);
                ctx.restore();
            }
            else if(item.type === 'sticker') {
                if(item.hasShadow) {
                    ctx.shadowColor = 'rgba(0,0,0,0.2)';
                    ctx.shadowBlur = 5; ctx.shadowOffsetX = 3; ctx.shadowOffsetY = 3;
                }
                const font = "sans-serif";
                ctx.font = `bold ${item.fontSize}px ${font}`;
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(item.text, cx, cy);
            } 
            else {
                const font = item.fontFamily;
                ctx.font = `bold ${item.fontSize}px ${font}`;
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';

                if(item.hasShadow) {
                    ctx.shadowColor = 'rgba(0,0,0,0.2)';
                    ctx.shadowBlur = 5; ctx.shadowOffsetX = 3; ctx.shadowOffsetY = 3;
                }
                if(item.hasOuter) {
                    ctx.lineWidth = strokeW + 12;
                    ctx.strokeStyle = item.outerColor;
                    ctx.strokeText(item.text, cx, cy);
                    ctx.shadowColor = 'transparent';
                }
                if(!item.hasOuter) ctx.shadowColor = 'transparent';
                ctx.lineWidth = strokeW;
                ctx.strokeStyle = item.strokeColor;
                ctx.strokeText(item.text, cx, cy);
                ctx.fillStyle = item.strokeColor;
                ctx.fillText(item.text, cx, cy);
                ctx.fillStyle = item.fillColor;
                ctx.fillText(item.text, cx, cy);
            }

            const scaleW = w * item.scale;
            const scaleH = h * item.scale;
            canvas.style.width = scaleW + 'px';
            canvas.style.height = scaleH + 'px';
            el.style.width = scaleW + 'px';
            el.style.height = scaleH + 'px';
        }

        // --- äº¤äº’ ---
        let dragInfo = null;
        function getPt(e) { return e.touches ? {x: e.touches[0].clientX, y: e.touches[0].clientY} : {x: e.clientX, y: e.clientY}; }

        function startDrag(e, item) {
            if(e.target.className.includes('handle')) return;
            e.preventDefault(); e.stopPropagation();
            setActiveItem(item.id);
            const pt = getPt(e);
            dragInfo = { type: 'move', item, startX: pt.x, startY: pt.y, initX: item.x, initY: item.y };
            bindEvents();
        }

        function startRotate(e, item) {
            e.preventDefault(); e.stopPropagation();
            const rect = document.getElementById(item.id).getBoundingClientRect();
            dragInfo = { type: 'rotate', item, cx: rect.left + rect.width/2, cy: rect.top + rect.height/2 };
            bindEvents();
        }

        function startResize(e, item) {
            e.preventDefault(); e.stopPropagation();
            const pt = getPt(e);
            const rect = document.getElementById(item.id).getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.top + rect.height/2;
            const dist = Math.hypot(pt.x - cx, pt.y - cy);
            dragInfo = { type: 'resize', item, cx, cy, startDist: dist, startScale: item.scale };
            bindEvents();
        }

        function onMove(e) {
            if(!dragInfo) return;
            e.preventDefault();
            const pt = getPt(e);
            const { item, type } = dragInfo;

            if(type === 'move') {
                item.x = dragInfo.initX + (pt.x - dragInfo.startX);
                item.y = dragInfo.initY + (pt.y - dragInfo.startY);
            } else if(type === 'rotate') {
                const angle = Math.atan2(pt.y - dragInfo.cy, pt.x - dragInfo.cx) * (180/Math.PI) + 90;
                item.rotation = angle;
                syncVal('rot', Math.round(angle) + 'Â°', angle);
            } else if(type === 'resize') {
                const dist = Math.hypot(pt.x - dragInfo.cx, pt.y - dragInfo.cy);
                item.scale = Math.max(0.2, dragInfo.startScale * (dist / dragInfo.startDist));
                // å®æ—¶æ›´æ–°ç¼©æ”¾å€¼
                if(item.type === 'image') {
                    const pct = Math.round(item.scale * 100);
                    syncVal('size', pct + '%', pct);
                }
            }
            drawItemCanvas(item);
        }

        function onUp() {
            dragInfo = null;
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('touchend', onUp);
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
        }

        function bindEvents() {
            document.addEventListener('touchmove', onMove, {passive: false});
            document.addEventListener('touchend', onUp);
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
        }

        // ç‚¹å‡»ç©ºç™½å–æ¶ˆ
        document.getElementById('canvas-wrapper').addEventListener('mousedown', deselect);
        document.getElementById('canvas-wrapper').addEventListener('touchstart', (e) => {
            if(e.target.id === 'canvas-wrapper' || e.target.id === 'canvas-container') deselect();
        });
        function deselect() { setActiveItem(null); }

        // --- UI ---
        function setActiveItem(id) {
            document.querySelectorAll('.draggable-item').forEach(e => e.classList.remove('active'));
            activeId = id;
            updateNavState();
            
            if(id) {
                document.getElementById(id).classList.add('active');
                const item = items.find(i => i.id === id);
                syncDrawer(item);
            } else {
                closeDrawer();
            }
        }

        function updateNavState() {
            const disabled = !activeId;
            document.querySelectorAll('.nav-item').forEach(n => {
                if(n.id !== 'nav-add') {
                    if(disabled) n.classList.add('disabled');
                    else n.classList.remove('disabled');
                }
            });
        }

        function switchTab(tab) {
            if(!activeId) return;
            const btn = document.getElementById('nav-'+tab);
            if(btn.classList.contains('active')) { closeDrawer(); return; }
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            btn.classList.add('active');
            openDrawer('main-drawer');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('tab-'+tab).classList.remove('hidden');
        }

        function syncDrawer(item) {
            const isText = item.type === 'text';
            const isImg = item.type === 'image';
            
            const els = {
                textGroup: document.getElementById('text-input-group'),
                palette: document.getElementById('palette-group'),
                fillColor: document.getElementById('wrap-fill'),
                strokeColor: document.getElementById('wrap-stroke'),
                outerColor: document.getElementById('wrap-outer'),
                fontGroup: document.getElementById('font-group'),
                rowRadius: document.getElementById('row-radius'),
                rowStroke: document.getElementById('row-stroke'),
                lblSize: document.getElementById('lbl-size'),
                lblWidth: document.getElementById('lbl-width'),
                lblStroke: document.getElementById('lbl-stroke'),
                optOuter: document.getElementById('opt-outer'),
                txtOuter: document.getElementById('txt-outer')
            };

            els.textGroup.style.display = isText ? 'block' : 'none';
            els.palette.style.display = isText ? 'block' : 'none';
            els.fontGroup.style.display = isText ? 'flex' : 'none';
            els.rowRadius.style.display = isImg ? 'flex' : 'none';
            
            els.lblSize.innerText = isImg ? 'ç¼©æ”¾' : 'å­—å·';
            els.lblWidth.innerText = isImg ? 'è¾¹æ¡†' : 'åšåº¦';
            els.lblStroke.innerText = isImg ? 'è¾¹æ¡†' : 'äº‘æœµ';
            els.txtOuter.innerText = isImg ? 'æ˜¾ç¤ºè¾¹æ¡†' : 'è½®å»“æè¾¹';

            els.fillColor.style.visibility = isText ? 'visible' : 'hidden';
            els.outerColor.style.visibility = isText ? 'visible' : 'hidden';
            els.strokeColor.style.visibility = (isText || isImg) ? 'visible' : 'hidden'; 

            syncVal('text', item.text);
            
            if (isImg) {
                const s = Math.round(item.scale * 100);
                syncVal('size', s + '%', s);
                const slider = document.getElementById('inp-size');
                slider.min = 10; slider.max = 300;
            } else {
                syncVal('size', item.fontSize, item.fontSize);
                const slider = document.getElementById('inp-size');
                slider.min = 20; slider.max = 250;
            }

            syncVal('width', item.strokeWidth, item.strokeWidth);
            syncVal('rot', Math.round(item.rotation) + 'Â°', item.rotation);
            syncVal('op', item.opacity, item.opacity);
            
            if(isImg) syncVal('radius', item.borderRadius, item.borderRadius);

            if(isText) {
                syncColor('fill', item.fillColor);
                syncColor('stroke', item.strokeColor);
                syncColor('outer', item.outerColor);
            } else if(isImg) {
                syncColor('stroke', item.strokeColor);
            }

            document.getElementById('chk-outer').checked = item.hasOuter;
            document.getElementById('chk-shadow').checked = item.hasShadow;
        }

        function syncVal(key, text, val) {
            const inp = document.getElementById('inp-'+key);
            const span = document.getElementById('val-'+key);
            if(inp && val !== undefined) inp.value = val;
            if(span && text !== undefined) span.innerText = text;
        }
        function syncColor(key, val) {
            document.getElementById('inp-'+key).value = val;
            document.getElementById('well-'+key).style.background = val;
        }

        function openDrawer(id) {
            document.querySelectorAll('.drawer').forEach(d => d.classList.remove('open'));
            document.getElementById(id).classList.add('open');
        }
        function closeDrawer() {
            document.querySelectorAll('.drawer').forEach(d => d.classList.remove('open'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        }

        function updateItem(key, val) {
            if(!activeId) return;
            const item = items.find(i => i.id === activeId);
            item[key] = val;
            drawItemCanvas(item);
            
            if(key === 'fontSize') document.getElementById('val-size').innerText = val;
            if(key === 'strokeWidth') document.getElementById('val-width').innerText = val;
            if(key === 'rotation') document.getElementById('val-rot').innerText = val + 'Â°';
            if(key === 'opacity') document.getElementById('val-op').innerText = val;
            if(key === 'borderRadius') document.getElementById('val-radius').innerText = val;
            
            if(key.includes('Color')) {
                const type = key.replace('Color','').replace('stroke','stroke'); 
                const well = document.getElementById('well-'+type.replace('Color','').toLowerCase());
                if(well) well.style.background = val;
                if(key === 'strokeColor' && item.type === 'image') document.getElementById('well-stroke').style.background = val;
            }
        }

        document.getElementById('inp-text').oninput = e => updateItem('text', e.target.value);
        document.getElementById('inp-size').oninput = e => {
            const val = parseInt(e.target.value);
            if(!activeId) return;
            const item = items.find(i => i.id === activeId);
            if(item.type === 'image') {
                item.scale = val / 100;
                document.getElementById('val-size').innerText = val + '%';
                drawItemCanvas(item);
            } else {
                updateItem('fontSize', val);
            }
        };
        document.getElementById('inp-width').oninput = e => updateItem('strokeWidth', parseInt(e.target.value));
        document.getElementById('inp-radius').oninput = e => updateItem('borderRadius', parseInt(e.target.value));
        document.getElementById('inp-rot').oninput = e => updateItem('rotation', parseInt(e.target.value));
        document.getElementById('inp-op').oninput = e => updateItem('opacity', parseInt(e.target.value));
        
        ['fill','stroke','outer'].forEach(k => {
            document.getElementById('inp-'+k).oninput = e => updateItem(k+'Color', e.target.value);
        });

        document.getElementById('chk-outer').onchange = e => updateItem('hasOuter', e.target.checked);
        document.getElementById('chk-shadow').onchange = e => updateItem('hasShadow', e.target.checked);
        document.getElementById('inp-font').onchange = e => updateItem('fontFamily', e.target.value);

        function modifyLayer(action) {
            if(!activeId) return;
            const item = items.find(i => i.id === activeId);
            if(action === 'top') item.zIndex = zIndexCounter++;
            if(action === 'bottom') item.zIndex = 1;
            if(action === 'up') item.zIndex++;
            if(action === 'down') item.zIndex--;
            drawItemCanvas(item);
        }
        function duplicateItem() {
            if(!activeId) return;
            const src = items.find(i => i.id === activeId);
            const copy = JSON.parse(JSON.stringify(src));
            copy.id = 'item-' + Date.now();
            copy.x += 30; copy.y += 30; copy.zIndex = zIndexCounter++;
            if(copy.type === 'image') { /* image needs special handling? No, src string is fine */ }
            items.push(copy);
            renderItemDOM(copy);
            setActiveItem(copy.id);
        }
        function deleteActiveItem() {
            if(!activeId) return;
            document.getElementById(activeId).remove();
            items = items.filter(i => i.id !== activeId);
            deselect(); closeDrawer();
        }

        function initPalettes() {
            const list = document.getElementById('palette-list');
            const pals = [
                { fill: '#ffecd2', stroke: '#ffffff', outer: '#ff9a9e' },
                { fill: '#e0c3fc', stroke: '#ffffff', outer: '#60a5fa' },
                { fill: '#d4fc79', stroke: '#ffffff', outer: '#4ade80' },
                { fill: '#f6d365', stroke: '#ffffff', outer: '#fb923c' },
                { fill: '#ff9a9e', stroke: '#ffffff', outer: '#f472b6' },
                { fill: '#374151', stroke: '#ffffff', outer: '#000000' },
            ];
            pals.forEach(p => {
                const div = document.createElement('div');
                div.className = 'palette-btn';
                div.style.background = `conic-gradient(${p.outer} 0% 33%, ${p.stroke} 33% 66%, ${p.fill} 66% 100%)`;
                div.onclick = () => {
                    if(!activeId) return;
                    updateItem('fillColor', p.fill);
                    updateItem('strokeColor', p.stroke);
                    updateItem('outerColor', p.outer);
                    syncColor('fill', p.fill); syncColor('stroke', p.stroke); syncColor('outer', p.outer);
                };
                list.appendChild(div);
            });
        }
        function filterStickers(cat) {
            const list = document.getElementById('sticker-list');
            list.innerHTML = '';
            stickers[cat].forEach(s => {
                const btn = document.createElement('button');
                btn.className = "text-3xl p-2 active:scale-90";
                btn.textContent = s;
                btn.onclick = () => { addSticker(s); };
                list.appendChild(btn);
            });
        }

        async function exportImage() {
            deselect(); closeDrawer();
            await new Promise(r => setTimeout(r, 100));
            
            const container = document.getElementById('canvas-container');
            const w = container.offsetWidth;
            const h = container.offsetHeight;
            const exCanvas = document.createElement('canvas');
            const dpr = 4;
            exCanvas.width = w * dpr; exCanvas.height = h * dpr;
            const ctx = exCanvas.getContext('2d');
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0,0,exCanvas.width, exCanvas.height);
            ctx.scale(dpr, dpr);

            const sorted = [...items].sort((a,b) => a.zIndex - b.zIndex);
            
            for(const item of sorted) {
                ctx.save();
                let iw, ih, fontSize=item.fontSize, pad;
                
                if(item.type === 'image') {
                    const strokeW = parseInt(item.strokeWidth || 0);
                    pad = strokeW + 20;
                    iw = item.width + pad*2;
                    ih = item.height + pad*2;
                } else {
                    const font = item.type==='sticker' ? 'sans-serif' : item.fontFamily;
                    ctx.font = `bold ${item.fontSize}px ${font}`;
                    const metrics = ctx.measureText(item.text);
                    const strokeW = parseInt(item.strokeWidth || 0);
                    pad = strokeW + 20;
                    iw = Math.ceil(metrics.width + pad * 2);
                    ih = Math.ceil((item.fontSize * 1.2) + pad * 2);
                }

                const finalW = iw * item.scale;
                const finalH = ih * item.scale;
                const cx = item.x + finalW/2;
                const cy = item.y + finalH/2;

                ctx.translate(cx, cy);
                ctx.rotate(item.rotation * Math.PI / 180);
                ctx.scale(item.scale, item.scale);
                ctx.globalAlpha = item.opacity / 100;
                ctx.translate(-iw/2, -ih/2);

                if(item.type === 'image') {
                    const img = new Image();
                    img.src = item.src;
                    await new Promise(r => { if(img.complete) r(); else img.onload = r; });
                    const radius = item.borderRadius;
                    const strokeW = item.strokeWidth;
                    
                    if(item.hasShadow) {
                        ctx.shadowColor = 'rgba(0,0,0,0.2)';
                        ctx.shadowBlur=5; ctx.shadowOffsetX=3; ctx.shadowOffsetY=3;
                        ctx.fillStyle = 'black';
                        ctx.roundRect(pad, pad, item.width, item.height, radius);
                        ctx.fill();
                        ctx.shadowColor = 'transparent';
                    }
                    if(item.hasOuter && strokeW > 0) {
                         ctx.lineWidth = strokeW;
                         ctx.strokeStyle = item.strokeColor;
                         ctx.beginPath();
                         ctx.roundRect(pad - strokeW/2, pad - strokeW/2, item.width + strokeW, item.height + strokeW, radius + strokeW/2);
                         ctx.stroke();
                    }
                    ctx.beginPath();
                    ctx.roundRect(pad, pad, item.width, item.height, radius);
                    ctx.clip();
                    ctx.drawImage(img, pad, pad, item.width, item.height);
                } else {
                    const drawCx = iw/2;
                    const drawCy = ih/2 + (item.fontSize * 0.05); 
                    const strokeW = parseInt(item.strokeWidth || 0);
                    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.lineJoin = 'round'; ctx.lineCap = 'round';

                    if(item.type === 'sticker') {
                        if(item.hasShadow) { ctx.shadowColor='rgba(0,0,0,0.2)'; ctx.shadowBlur=5; ctx.shadowOffsetX=3; ctx.shadowOffsetY=3; }
                        ctx.fillText(item.text, drawCx, drawCy);
                    } else {
                         if(item.hasShadow) { ctx.shadowColor='rgba(0,0,0,0.2)'; ctx.shadowBlur=5; ctx.shadowOffsetX=3; ctx.shadowOffsetY=3; }
                        if(item.hasOuter) { ctx.lineWidth=strokeW+12; ctx.strokeStyle=item.outerColor; ctx.strokeText(item.text, drawCx, drawCy); ctx.shadowColor='transparent'; }
                        if(!item.hasOuter) ctx.shadowColor='transparent';
                        ctx.lineWidth=strokeW; ctx.strokeStyle=item.strokeColor; ctx.strokeText(item.text, drawCx, drawCy);
                        ctx.fillStyle=item.strokeColor; ctx.fillText(item.text, drawCx, drawCy);
                        ctx.fillStyle=item.fillColor; ctx.fillText(item.text, drawCx, drawCy);
                    }
                }
                ctx.restore();
            }

            const link = document.createElement('a');
            link.download = `tim_cloud_${Date.now()}.png`;
            link.href = exCanvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>
</html>
