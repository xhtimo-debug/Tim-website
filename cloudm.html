<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº‘æœµå­—ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Zcool+KuaiLe&family=Pacifico&family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@400;700&family=Nunito:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --header-h: 60px;
            --nav-h: 70px; 
        }

        body {
            font-family: 'Fredoka One', 'Zcool KuaiLe', sans-serif;
            background-color: #f3f4f6;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
        }

        /* --- 1. é¡¶éƒ¨æ  --- */
        #app-header {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: var(--header-h);
            background: white;
            z-index: 50; 
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* --- 2. åº•éƒ¨æ  (å±‚çº§æœ€é«˜) --- */
        #app-bottom-nav {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: var(--nav-h);
            background: white;
            z-index: 6000; /* ç¡®ä¿åœ¨æŠ½å±‰ä¹‹ä¸Š */
            border-top: 1px solid #e2e8f0;
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- 3. ç”»å¸ƒåŒºåŸŸ --- */
        #canvas-wrapper {
            position: absolute;
            top: var(--header-h);
            bottom: var(--nav-h);
            left: 0; right: 0;
            background: #f1f5f9;
            z-index: 1; 
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }

        #canvas-container {
            background-color: white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        /* --- 4. æŠ½å±‰ (ä½äºå¯¼èˆªæ ä¸Šæ–¹) --- */
        .drawer {
            position: absolute;
            left: 0; right: 0;
            /* å…³é”®ä¿®æ”¹ï¼šåº•éƒ¨ä½ç½®è®¾ä¸ºå¯¼èˆªæ é«˜åº¦ï¼Œé¿å…é®æŒ¡ */
            bottom: var(--nav-h); 
            height: 45vh; 
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
            z-index: 5000; /* ä½äºåº•éƒ¨å¯¼èˆªæ  */
            transform: translateY(120%); /* é»˜è®¤å‘ä¸‹éšè— */
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column;
            border-bottom: 1px solid #f1f5f9;
        }
        .drawer.open { transform: translateY(0); }

        .drawer-header {
            flex-shrink: 0; padding: 12px 16px; border-bottom: 1px solid #f1f5f9;
            display: flex; justify-content: space-between; align-items: center;
        }
        .drawer-content {
            flex: 1; overflow-y: auto; padding: 16px;
        }

        /* --- ç»„ä»¶æ ·å¼ --- */
        .top-btn {
            display: flex; align-items: center; gap: 4px; padding: 8px 12px;
            border-radius: 99px; font-size: 12px; font-weight: bold;
            background: #eff6ff; color: #3b82f6; transition: all 0.1s;
        }
        .top-btn:active { transform: scale(0.95); background: #dbeafe; }
        .top-btn.save { background: #3b82f6; color: white; margin-left: auto; }
        .top-btn.sticker { background: #fff7ed; color: #f59e0b; }

        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; width: 60px; gap: 2px;
            color: #94a3b8; font-size: 10px; font-weight: bold;
            transition: color 0.2s;
        }
        .nav-item i { font-size: 22px; }
        .nav-item.active { color: #3b82f6; }
        /* å¢åŠ æŒ‰å‹æ•ˆæœ */
        .nav-item:active { transform: scale(0.95); } 
        .nav-item.disabled { opacity: 0.3; filter: grayscale(1); pointer-events: none; }

        /* å…ƒç´ æ ·å¼ */
        .draggable-item {
            position: absolute; padding: 0; border: 1px dashed transparent;
            transform-origin: center center;
        }
        .draggable-item.active { border-color: #3b82f6; z-index: 1000; }

        .handle-btn {
            position: absolute; width: 32px; height: 32px; background: white;
            border: 2px solid #3b82f6; border-radius: 50%;
            display: none; z-index: 2000;
            align-items: center; justify-content: center; color: #3b82f6; font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .draggable-item.active .handle-btn { display: flex; }
        .rotate-handle { top: -45px; left: 50%; transform: translateX(-50%); color: #10b981; border-color: #10b981; }
        .rotate-handle::after { content:''; position: absolute; top: 30px; width: 1px; height: 15px; background: #10b981; }
        .resize-handle { bottom: -16px; right: -16px; }
        .delete-handle { top: -16px; left: -16px; color: #ef4444; border-color: #ef4444; }

        /* UI å°éƒ¨ä»¶ */
        .color-well { width: 36px; height: 36px; border-radius: 8px; border: 2px solid #e2e8f0; position: relative; overflow: hidden; }
        .color-well input { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; opacity: 0; }
        
        .prop-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .prop-label { width: 50px; font-size: 12px; font-weight: bold; color: #64748b; }
        .prop-val { width: 30px; font-size: 12px; font-family: monospace; color: #3b82f6; text-align: right; }
        
        input[type="range"] { flex: 1; height: 6px; background: #e2e8f0; border-radius: 3px; outline: none; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: white; border: 2px solid #3b82f6; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .palette-btn { width: 40px; height: 40px; flex-shrink: 0; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <!-- 1. é¡¶éƒ¨æ  -->
    <header id="app-header">
        <div class="flex gap-2">
            <button onclick="addCloudText()" class="top-btn">
                <i class="fa-solid fa-plus"></i> æ–‡å­—
            </button>
            <button onclick="openDrawer('drawer-stickers')" class="top-btn sticker">
                <i class="fa-regular fa-face-smile"></i> è´´çº¸
            </button>
        </div>
        <button onclick="exportImage()" class="top-btn save">
            <i class="fa-solid fa-download"></i> ä¿å­˜
        </button>
    </header>

    <!-- 2. ç”»å¸ƒåŒºåŸŸ -->
    <div id="canvas-wrapper">
        <div id="canvas-container">
            <!-- çº¯ç™½èƒŒæ™¯ -->
            <div class="absolute inset-0 bg-white"></div>
            <!-- ç½‘æ ¼ -->
            <div id="grid-layer" class="absolute inset-0 pointer-events-none opacity-10" 
                 style="background-image: linear-gradient(#94a3b8 1px, transparent 1px), linear-gradient(90deg, #94a3b8 1px, transparent 1px); background-size: 20px 20px;">
            </div>
            <!-- å…ƒç´ å±‚ -->
            <div id="item-layer" class="absolute inset-0 w-full h-full overflow-hidden"></div>
        </div>
    </div>

    <!-- 3. åº•éƒ¨å¯¼èˆªæ  (ç°åœ¨åœ¨æŠ½å±‰ä¸Šæ–¹) -->
    <nav id="app-bottom-nav">
        <button onclick="switchTab('style')" class="nav-item" id="nav-style">
            <i class="fa-solid fa-paintbrush"></i> æ ·å¼
        </button>
        <button onclick="switchTab('adjust')" class="nav-item" id="nav-adjust">
            <i class="fa-solid fa-sliders"></i> è°ƒæ•´
        </button>
        <button onclick="switchTab('tools')" class="nav-item" id="nav-tools">
            <i class="fa-solid fa-layer-group"></i> å·¥å…·
        </button>
    </nav>

    <!-- 4. å±æ€§ç¼–è¾‘æŠ½å±‰ (ä½äºåº•éƒ¨å¯¼èˆªæ ä¹‹ä¸Š) -->
    <div id="main-drawer" class="drawer">
        <div class="drawer-header">
            <h3 class="font-bold text-gray-800" id="drawer-title">å±æ€§</h3>
            <button onclick="closeDrawer()" class="text-gray-400 p-2"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="drawer-content">
            
            <!-- Tab: æ ·å¼ -->
            <div id="tab-style" class="tab-content hidden">
                <div id="text-input-group" class="mb-4">
                    <label class="text-xs text-gray-400 font-bold mb-2 block">å†…å®¹</label>
                    <input type="text" id="inp-text" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                </div>
                
                <div class="mb-4">
                    <label class="text-xs text-gray-400 font-bold mb-2 block">ä¸€é”®é…è‰²</label>
                    <div class="flex gap-3 overflow-x-auto hide-scrollbar p-1" id="palette-list"></div>
                </div>

                <div>
                    <label class="text-xs text-gray-400 font-bold mb-2 block">è‡ªå®šä¹‰é¢œè‰²</label>
                    <div class="flex justify-around bg-gray-50 p-3 rounded-xl border border-gray-100">
                        <div class="flex flex-col items-center gap-1">
                            <div class="color-well" style="background:#3b82f6" id="well-fill">
                                <input type="color" id="inp-fill">
                            </div>
                            <span class="text-[10px] text-gray-500">å­—è‰²</span>
                        </div>
                        <div class="flex flex-col items-center gap-1" id="wrap-stroke">
                            <div class="color-well" style="background:#ffffff" id="well-stroke">
                                <input type="color" id="inp-stroke">
                            </div>
                            <span class="text-[10px] text-gray-500">äº‘æœµ</span>
                        </div>
                        <div class="flex flex-col items-center gap-1" id="wrap-outer">
                            <div class="color-well" style="background:#93c5fd" id="well-outer">
                                <input type="color" id="inp-outer">
                            </div>
                            <span class="text-[10px] text-gray-500">è½®å»“</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: è°ƒæ•´ -->
            <div id="tab-adjust" class="tab-content hidden">
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg mb-4 border border-gray-100" id="font-group">
                    <span class="text-xs font-bold text-gray-600">å­—ä½“æ ·å¼</span>
                    <select id="inp-font" class="bg-white border border-gray-200 text-xs rounded px-2 py-1 outline-none text-gray-600 w-32">
                        <option value="'Fredoka One', cursive">Fredoka One</option>
                        <option value="'Zcool KuaiLe', cursive">ç«™é…·å¿«ä¹ä½“</option>
                        <option value="'Pacifico', cursive">Pacifico</option>
                        <option value="'Ma Shan Zheng', cursive">é©¬å–„æ”¿</option>
                        <option value="'Nunito', sans-serif">Nunito</option>
                    </select>
                </div>

                <div class="prop-row">
                    <span class="prop-label">å­—å·</span>
                    <input type="range" id="inp-size" min="20" max="250">
                    <span class="prop-val" id="val-size">80</span>
                </div>
                <div class="prop-row" id="row-stroke">
                    <span class="prop-label">åšåº¦</span>
                    <input type="range" id="inp-width" min="0" max="80">
                    <span class="prop-val" id="val-width">20</span>
                </div>
                <div class="prop-row">
                    <span class="prop-label">æ—‹è½¬</span>
                    <input type="range" id="inp-rot" min="-180" max="180">
                    <span class="prop-val" id="val-rot">0Â°</span>
                </div>
                <div class="prop-row">
                    <span class="prop-label">é€æ˜</span>
                    <input type="range" id="inp-op" min="0" max="100">
                    <span class="prop-val" id="val-op">100</span>
                </div>

                <div class="flex gap-4 pt-2">
                    <label class="flex items-center gap-2 text-xs font-bold text-gray-600">
                        <input type="checkbox" id="chk-outer" class="accent-blue-500 w-4 h-4"> è½®å»“æè¾¹
                    </label>
                    <label class="flex items-center gap-2 text-xs font-bold text-gray-600">
                        <input type="checkbox" id="chk-shadow" class="accent-blue-500 w-4 h-4"> æŠ•å½±
                    </label>
                </div>
            </div>

            <!-- Tab: å·¥å…· -->
            <div id="tab-tools" class="tab-content hidden">
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="modifyLayer('up')" class="bg-gray-50 py-3 rounded-lg text-xs font-bold text-gray-600 active:bg-gray-200">ä¸Šç§»ä¸€å±‚</button>
                    <button onclick="modifyLayer('down')" class="bg-gray-50 py-3 rounded-lg text-xs font-bold text-gray-600 active:bg-gray-200">ä¸‹ç§»ä¸€å±‚</button>
                    <button onclick="modifyLayer('top')" class="bg-gray-50 py-3 rounded-lg text-xs font-bold text-gray-600 active:bg-gray-200">ç½®é¡¶</button>
                    <button onclick="modifyLayer('bottom')" class="bg-gray-50 py-3 rounded-lg text-xs font-bold text-gray-600 active:bg-gray-200">ç½®åº•</button>
                </div>
                <div class="border-t border-gray-100 my-4"></div>
                <button onclick="duplicateItem()" class="w-full bg-blue-50 text-blue-600 py-3 rounded-lg text-xs font-bold active:bg-blue-100 mb-3 flex items-center justify-center gap-2">
                    <i class="fa-regular fa-copy"></i> å¤åˆ¶å…ƒç´ 
                </button>
                <button onclick="deleteActiveItem()" class="w-full bg-red-50 text-red-500 py-3 rounded-lg text-xs font-bold active:bg-red-100 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-trash-can"></i> åˆ é™¤å…ƒç´ 
                </button>
            </div>
        </div>
    </div>

    <!-- 5. è´´çº¸æŠ½å±‰ -->
    <div id="drawer-stickers" class="drawer">
        <div class="drawer-header">
            <h3 class="font-bold">é€‰æ‹©è´´çº¸</h3>
            <button onclick="closeDrawer()" class="text-gray-400 p-2"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="drawer-content">
            <div id="sticker-list" class="grid grid-cols-5 gap-4"></div>
        </div>
    </div>

    <script>
        let items = [];
        let activeId = null;
        let zIndexCounter = 100;
        let isAutoFit = true;

        const palettes = [
            { fill: '#ffecd2', stroke: '#ffffff', outer: '#ff9a9e' },
            { fill: '#e0c3fc', stroke: '#ffffff', outer: '#60a5fa' },
            { fill: '#d4fc79', stroke: '#ffffff', outer: '#4ade80' },
            { fill: '#f6d365', stroke: '#ffffff', outer: '#fb923c' },
            { fill: '#ff9a9e', stroke: '#ffffff', outer: '#f472b6' },
            { fill: '#374151', stroke: '#ffffff', outer: '#000000' },
        ];

        window.onload = () => {
            initCanvasSize();
            loadStickers();
            initPalettes();
            setTimeout(() => addCloudText(), 100);
            updateNavState();
        };

        window.addEventListener('resize', initCanvasSize);

        function initCanvasSize() {
            const wrapper = document.getElementById('canvas-wrapper');
            const container = document.getElementById('canvas-container');
            const w = wrapper.clientWidth - 20; 
            const h = wrapper.clientHeight - 20;
            const size = Math.min(w, h);
            container.style.width = size + 'px';
            container.style.height = size + 'px';
        }

        // --- æ ¸å¿ƒæ“ä½œ ---
        function addCloudText() {
            createItem('text', 'Tim');
        }
        function addSticker(s) {
            createItem('sticker', s);
            closeDrawer();
        }

        function createItem(type, content) {
            const id = 'item-' + Date.now();
            const item = {
                id, type,
                x: 100 + (items.length * 5) % 50, 
                y: 100 + (items.length * 5) % 50,
                scale: 1, rotation: 0, opacity: 100, zIndex: zIndexCounter++,
                text: content,
                fontFamily: "'Fredoka One', cursive",
                fontSize: type === 'text' ? 80 : 120,
                fillColor: type === 'text' ? '#3b82f6' : 'transparent',
                strokeColor: type === 'text' ? '#ffffff' : 'transparent',
                strokeWidth: type === 'text' ? 20 : 0,
                hasOuter: type === 'text', outerColor: '#93c5fd',
                hasShadow: false
            };
            items.push(item);
            renderItemDOM(item);
            setActiveItem(id);
            if(type === 'text') switchTab('style');
        }

        // --- æ¸²æŸ“ ---
        function renderItemDOM(item) {
            const el = document.createElement('div');
            el.id = item.id;
            el.className = 'draggable-item';
            el.style.zIndex = item.zIndex;

            const canvas = document.createElement('canvas');
            el.appendChild(canvas);

            // Controls
            const btn = (cls, icon) => `<div class="handle-btn ${cls}"><i class="fa-solid ${icon}"></i></div>`;
            el.innerHTML += btn('delete-handle', 'fa-xmark') + btn('rotate-handle', 'fa-rotate') + btn('resize-handle', 'fa-expand');

            // Events
            const delBtn = el.querySelector('.delete-handle');
            delBtn.ontouchstart = (e) => { e.stopPropagation(); deleteActiveItem(); };
            delBtn.onmousedown = (e) => { e.stopPropagation(); deleteActiveItem(); }; 

            const rotBtn = el.querySelector('.rotate-handle');
            rotBtn.ontouchstart = (e) => startRotate(e, item);
            rotBtn.onmousedown = (e) => startRotate(e, item);

            const resBtn = el.querySelector('.resize-handle');
            resBtn.ontouchstart = (e) => startResize(e, item);
            resBtn.onmousedown = (e) => startResize(e, item);

            el.addEventListener('touchstart', (e) => startDrag(e, item), {passive: false});
            el.addEventListener('mousedown', (e) => startDrag(e, item));

            document.getElementById('item-layer').appendChild(el);
            drawItemCanvas(item);
        }

        function drawItemCanvas(item) {
            const el = document.getElementById(item.id);
            if(!el) return;
            const canvas = el.querySelector('canvas');
            const ctx = canvas.getContext('2d');
            const dpr = 2; 

            el.style.transform = `rotate(${item.rotation}deg)`;
            el.style.left = item.x + 'px';
            el.style.top = item.y + 'px';
            el.style.zIndex = item.zIndex;
            el.style.opacity = item.opacity / 100;

            const isSticker = item.type === 'sticker';
            const font = isSticker ? "sans-serif" : item.fontFamily;
            ctx.font = `bold ${item.fontSize}px ${font}`;
            
            const metrics = ctx.measureText(item.text);
            const wText = metrics.width;
            const hText = item.fontSize * 1.2;
            const strokeW = parseInt(item.strokeWidth || 0);
            const pad = strokeW + 20;
            const w = Math.ceil(wText + pad * 2);
            const h = Math.ceil(hText + pad * 2);

            canvas.width = w * dpr; canvas.height = h * dpr;
            ctx.scale(dpr, dpr);
            
            ctx.font = `bold ${item.fontSize}px ${font}`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            const cx = w/2, cy = h/2 + (item.fontSize * 0.05);
            ctx.lineJoin = 'round'; ctx.lineCap = 'round';

            // Draw
            ctx.clearRect(0,0,w,h);

            if(isSticker) {
                if(item.hasShadow) {
                    ctx.shadowColor = 'rgba(0,0,0,0.2)';
                    ctx.shadowBlur = 5; ctx.shadowOffsetX = 3; ctx.shadowOffsetY = 3;
                }
                ctx.fillText(item.text, cx, cy);
            } else {
                if(item.hasShadow) {
                    ctx.shadowColor = 'rgba(0,0,0,0.2)';
                    ctx.shadowBlur = 5; ctx.shadowOffsetX = 3; ctx.shadowOffsetY = 3;
                }
                if(item.hasOuter) {
                    ctx.lineWidth = strokeW + 12;
                    ctx.strokeStyle = item.outerColor;
                    ctx.strokeText(item.text, cx, cy);
                    ctx.shadowColor = 'transparent';
                }
                if(!item.hasOuter) ctx.shadowColor = 'transparent';
                ctx.lineWidth = strokeW;
                ctx.strokeStyle = item.strokeColor;
                ctx.strokeText(item.text, cx, cy);
                ctx.fillStyle = item.strokeColor;
                ctx.fillText(item.text, cx, cy);
                ctx.fillStyle = item.fillColor;
                ctx.fillText(item.text, cx, cy);
            }

            const scaleW = w * item.scale;
            const scaleH = h * item.scale;
            canvas.style.width = scaleW + 'px';
            canvas.style.height = scaleH + 'px';
            el.style.width = scaleW + 'px';
            el.style.height = scaleH + 'px';
        }

        // --- äº¤äº’ ---
        let dragInfo = null;
        function getPt(e) { return e.touches ? {x: e.touches[0].clientX, y: e.touches[0].clientY} : {x: e.clientX, y: e.clientY}; }

        function startDrag(e, item) {
            if(e.target.className.includes('handle')) return;
            e.preventDefault(); e.stopPropagation();
            setActiveItem(item.id);
            const pt = getPt(e);
            dragInfo = { type: 'move', item, startX: pt.x, startY: pt.y, initX: item.x, initY: item.y };
            bindEvents();
        }

        function startRotate(e, item) {
            e.preventDefault(); e.stopPropagation();
            const rect = document.getElementById(item.id).getBoundingClientRect();
            dragInfo = { type: 'rotate', item, cx: rect.left + rect.width/2, cy: rect.top + rect.height/2 };
            bindEvents();
        }

        function startResize(e, item) {
            e.preventDefault(); e.stopPropagation();
            const pt = getPt(e);
            const rect = document.getElementById(item.id).getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.top + rect.height/2;
            const dist = Math.hypot(pt.x - cx, pt.y - cy);
            dragInfo = { type: 'resize', item, cx, cy, startDist: dist, startScale: item.scale };
            bindEvents();
        }

        function onMove(e) {
            if(!dragInfo) return;
            e.preventDefault();
            const pt = getPt(e);
            const { item, type } = dragInfo;

            if(type === 'move') {
                item.x = dragInfo.initX + (pt.x - dragInfo.startX);
                item.y = dragInfo.initY + (pt.y - dragInfo.startY);
            } else if(type === 'rotate') {
                const angle = Math.atan2(pt.y - dragInfo.cy, pt.x - dragInfo.cx) * (180/Math.PI) + 90;
                item.rotation = angle;
                syncVal('rot', Math.round(angle) + 'Â°', angle);
            } else if(type === 'resize') {
                const dist = Math.hypot(pt.x - dragInfo.cx, pt.y - dragInfo.cy);
                item.scale = Math.max(0.2, dragInfo.startScale * (dist / dragInfo.startDist));
            }
            drawItemCanvas(item);
        }

        function onUp() {
            dragInfo = null;
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('touchend', onUp);
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
        }

        function bindEvents() {
            document.addEventListener('touchmove', onMove, {passive: false});
            document.addEventListener('touchend', onUp);
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
        }

        // ç‚¹å‡»ç©ºç™½å–æ¶ˆ
        document.getElementById('canvas-wrapper').addEventListener('mousedown', deselect);
        document.getElementById('canvas-wrapper').addEventListener('touchstart', (e) => {
            if(e.target.id === 'canvas-wrapper' || e.target.id === 'canvas-container') deselect();
        });
        function deselect() { setActiveItem(null); }

        // --- UI ---
        function setActiveItem(id) {
            document.querySelectorAll('.draggable-item').forEach(e => e.classList.remove('active'));
            activeId = id;
            updateNavState();
            
            if(id) {
                document.getElementById(id).classList.add('active');
                const item = items.find(i => i.id === id);
                syncDrawer(item);
                // é€‰ä¸­æ—¶ä¸è‡ªåŠ¨æ‰“å¼€æŠ½å±‰ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»
            } else {
                closeDrawer();
            }
        }

        function updateNavState() {
            const disabled = !activeId;
            document.querySelectorAll('.nav-item').forEach(n => {
                if(n.id !== 'nav-add') {
                    if(disabled) n.classList.add('disabled');
                    else n.classList.remove('disabled');
                }
            });
        }

        function switchTab(tab) {
            if(!activeId) return;
            const btn = document.getElementById('nav-'+tab);
            
            // æ ¸å¿ƒä¿®å¤ï¼šToggle é€»è¾‘ (å¦‚æœå·²æ¿€æ´»ï¼Œåˆ™å…³é—­)
            if(btn.classList.contains('active')) {
                closeDrawer();
                return;
            }

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            btn.classList.add('active');
            
            openDrawer('main-drawer');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('tab-'+tab).classList.remove('hidden');
            
            const titles = { style:'å¤–è§‚æ ·å¼', adjust:'ç»†èŠ‚å‚æ•°', tools:'å·¥å…·ç®±' };
            document.getElementById('drawer-title').innerText = titles[tab];
        }

        function syncDrawer(item) {
            const isSticker = item.type === 'sticker';
            
            // æ˜¾éš
            const stickerHide = ['text-input-group', 'wrap-stroke', 'wrap-outer', 'row-stroke', 'font-group'];
            stickerHide.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.style.display = isSticker ? 'none' : (id.includes('wrap') ? 'flex' : 'flex');
                if(id === 'text-input-group' && el) el.style.display = isSticker ? 'none' : 'block';
            });

            // å€¼
            syncVal('text', item.text, item.text);
            syncVal('size', item.fontSize, item.fontSize);
            syncVal('rot', Math.round(item.rotation) + 'Â°', item.rotation);
            syncVal('op', item.opacity, item.opacity);
            
            if(!isSticker) {
                syncVal('stroke', item.strokeWidth, item.strokeWidth);
                syncColor('fill', item.fillColor);
                syncColor('stroke', item.strokeColor);
                syncColor('outer', item.outerColor);
                document.getElementById('chk-outer').checked = item.hasOuter;
                document.getElementById('chk-shadow').checked = item.hasShadow;
            }
        }

        function syncVal(key, text, val) {
            const inp = document.getElementById('inp-'+key);
            const span = document.getElementById('val-'+key);
            if(inp) inp.value = val;
            if(span) span.innerText = text;
        }
        function syncColor(key, val) {
            document.getElementById('inp-'+key).value = val;
            document.getElementById('well-'+key).style.background = val;
        }

        function openDrawer(id) {
            document.querySelectorAll('.drawer').forEach(d => d.classList.remove('open'));
            document.getElementById(id).classList.add('open');
        }
        function closeDrawer() {
            document.querySelectorAll('.drawer').forEach(d => d.classList.remove('open'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        }

        // --- æ›´æ–° ---
        function updateItem(key, val) {
            if(!activeId) return;
            const item = items.find(i => i.id === activeId);
            item[key] = val;
            drawItemCanvas(item);
            
            if(key === 'fontSize') document.getElementById('val-size').innerText = val;
            if(key === 'strokeWidth') document.getElementById('val-stroke').innerText = val;
            if(key === 'rotation') document.getElementById('val-rot').innerText = val + 'Â°';
            if(key === 'opacity') document.getElementById('val-op').innerText = val;
            if(key.includes('Color')) {
                const type = key.replace('Color','');
                document.getElementById('well-'+type).style.background = val;
            }
        }

        // Bindings
        document.getElementById('inp-text').oninput = e => updateItem('text', e.target.value);
        document.getElementById('inp-size').oninput = e => updateItem('fontSize', parseInt(e.target.value));
        document.getElementById('inp-stroke').oninput = e => updateItem('strokeWidth', parseInt(e.target.value));
        document.getElementById('inp-rot').oninput = e => updateItem('rotation', parseInt(e.target.value));
        document.getElementById('inp-op').oninput = e => updateItem('opacity', parseInt(e.target.value));
        
        ['fill','stroke','outer'].forEach(k => {
            document.getElementById('inp-'+k).oninput = e => updateItem(k+'Color', e.target.value);
        });
        
        document.getElementById('chk-outer').onchange = e => updateItem('hasOuter', e.target.checked);
        document.getElementById('chk-shadow').onchange = e => updateItem('hasShadow', e.target.checked);
        document.getElementById('inp-font').onchange = e => updateItem('fontFamily', e.target.value);

        // Tools
        function modifyLayer(action) {
            if(!activeId) return;
            const item = items.find(i => i.id === activeId);
            if(action === 'top') item.zIndex = zIndexCounter++;
            if(action === 'bottom') item.zIndex = 1;
            if(action === 'up') item.zIndex++;
            if(action === 'down') item.zIndex--;
            drawItemCanvas(item);
            // ä¿æŒé€‰ä¸­ï¼Œä½†å…³é—­æŠ½å±‰ä»¥ä¾¿è§‚å¯Ÿ
            closeDrawer();
        }
        function duplicateItem() {
            if(!activeId) return;
            const src = items.find(i => i.id === activeId);
            const copy = JSON.parse(JSON.stringify(src));
            copy.id = 'item-' + Date.now();
            copy.x += 30; copy.y += 30; copy.zIndex = zIndexCounter++;
            items.push(copy);
            renderItemDOM(copy);
            setActiveItem(copy.id);
        }
        function deleteActiveItem() {
            if(!activeId) return;
            document.getElementById(activeId).remove();
            items = items.filter(i => i.id !== activeId);
            deselect(); closeDrawer();
        }

        function initPalettes() {
            const list = document.getElementById('palette-list');
            const pals = [
                { fill: '#ffecd2', stroke: '#ffffff', outer: '#ff9a9e' },
                { fill: '#e0c3fc', stroke: '#ffffff', outer: '#60a5fa' },
                { fill: '#d4fc79', stroke: '#ffffff', outer: '#4ade80' },
                { fill: '#f6d365', stroke: '#ffffff', outer: '#fb923c' },
                { fill: '#ff9a9e', stroke: '#ffffff', outer: '#f472b6' },
                { fill: '#374151', stroke: '#ffffff', outer: '#000000' },
            ];
            pals.forEach(p => {
                const div = document.createElement('div');
                div.className = 'palette-btn';
                div.style.background = `conic-gradient(${p.outer} 0% 33%, ${p.stroke} 33% 66%, ${p.fill} 66% 100%)`;
                div.onclick = () => {
                    if(!activeId) return;
                    updateItem('fillColor', p.fill);
                    updateItem('strokeColor', p.stroke);
                    updateItem('outerColor', p.outer);
                    syncColor('fill', p.fill); syncColor('stroke', p.stroke); syncColor('outer', p.outer);
                };
                list.appendChild(div);
            });
        }

        function loadStickers() {
            const list = document.getElementById('sticker-list');
            const s = ['ğŸ˜Š','ğŸ˜‚','ğŸ¥°','ğŸ˜','ğŸ¤”','ğŸ˜­','ğŸ˜¡','ğŸ‘','ğŸ‰','ğŸ”¥','â¤ï¸','ğŸŒ¸','ğŸŒ»','ğŸ”','ğŸŸ','ğŸš—','ğŸš€','ğŸ±','ğŸ¶','ğŸ°'];
            s.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = "text-3xl p-2 active:scale-90";
                btn.textContent = emoji;
                btn.onclick = () => { addSticker(emoji); };
                list.appendChild(btn);
            });
        }

        // --- Export ---
        async function exportImage() {
            deselect(); closeDrawer();
            await new Promise(r => setTimeout(r, 100)); // UI settle
            
            const container = document.getElementById('canvas-container');
            const w = container.offsetWidth;
            const h = container.offsetHeight;
            const exCanvas = document.createElement('canvas');
            const dpr = 4;
            exCanvas.width = w * dpr; exCanvas.height = h * dpr;
            const ctx = exCanvas.getContext('2d');
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0,0,exCanvas.width, exCanvas.height);
            ctx.scale(dpr, dpr);

            const sorted = [...items].sort((a,b) => a.zIndex - b.zIndex);
            
            for(const item of sorted) {
                const isSticker = item.type === 'sticker';
                const font = isSticker ? "sans-serif" : item.fontFamily;
                ctx.font = `bold ${item.fontSize}px ${font}`;
                const metrics = ctx.measureText(item.text);
                const wText = metrics.width;
                const hText = item.fontSize * 1.2;
                const strokeW = parseInt(item.strokeWidth || 0);
                const pad = strokeW + 20;
                const iw = Math.ceil(wText + pad * 2);
                const ih = Math.ceil(hText + pad * 2);
                
                const finalW = iw * item.scale;
                const finalH = ih * item.scale;
                const cx = item.x + finalW / 2;
                const cy = item.y + finalH / 2;

                ctx.save();
                ctx.translate(cx, cy);
                ctx.rotate(item.rotation * Math.PI / 180);
                ctx.scale(item.scale, item.scale);
                ctx.globalAlpha = item.opacity / 100;
                ctx.translate(-iw/2, -ih/2);

                const dcx = iw/2, dcy = ih/2 + (item.fontSize * 0.05);
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.lineJoin = 'round'; ctx.lineCap = 'round';

                if(isSticker) {
                    if(item.hasShadow) { ctx.shadowColor='rgba(0,0,0,0.2)'; ctx.shadowBlur=5; ctx.shadowOffsetX=3; ctx.shadowOffsetY=3; }
                    ctx.fillText(item.text, dcx, dcy);
                } else {
                    if(item.hasShadow) { ctx.shadowColor='rgba(0,0,0,0.2)'; ctx.shadowBlur=5; ctx.shadowOffsetX=3; ctx.shadowOffsetY=3; }
                    if(item.hasOuter) { ctx.lineWidth=strokeW+12; ctx.strokeStyle=item.outerColor; ctx.strokeText(item.text, dcx, dcy); ctx.shadowColor='transparent'; }
                    if(!item.hasOuter) ctx.shadowColor='transparent';
                    ctx.lineWidth=strokeW; ctx.strokeStyle=item.strokeColor; ctx.strokeText(item.text, dcx, dcy);
                    ctx.fillStyle=item.strokeColor; ctx.fillText(item.text, dcx, dcy);
                    ctx.fillStyle=item.fillColor; ctx.fillText(item.text, dcx, dcy);
                }
                ctx.restore();
            }

            const link = document.createElement('a');
            link.download = `tim_cloud_${Date.now()}.png`;
            link.href = exCanvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>
</html>
